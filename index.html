<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador Financeiro v10.7 - Pagamentos Parciais</title> <!-- Versão Atualizada -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Reset Básico e Configurações Globais */  
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; }
        body { display: flex; height: 100vh; background-color: #121212; color: #e0e0e0; overflow: hidden; position: relative; }

        /* --- Scrollbars Customizadas (Opcional) --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #2a2a2a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background-color: #555; border-radius: 4px; border: 2px solid #2a2a2a; }
        ::-webkit-scrollbar-thumb:hover { background-color: #777; }

        /* --- Menu Lateral --- */
        .sidebar { width: 240px; background-color: #1e1e1e; color: #a0a0a0; padding: 20px 10px; display: flex; flex-direction: column; height: 100vh; flex-shrink: 0; box-shadow: 4px 0px 15px rgba(0, 0, 0, 0.3); z-index: 10; overflow-y: auto; transition: transform 0.3s ease-in-out; }
        .sidebar h2 { text-align: center; margin-bottom: 35px; font-size: 1.4em; color: #ffffff; padding-bottom: 15px; flex-shrink: 0; }
        .sidebar nav { flex-grow: 1; }
        .sidebar nav ul { list-style: none; padding-left: 0; }
        .sidebar nav ul li { margin-bottom: 8px; }
        .sidebar nav ul li a { display: flex; align-items: center; padding: 12px 20px; color: #a0a0a0; text-decoration: none; border-radius: 6px; transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease; font-size: 0.95em; font-weight: 500; position: relative; }
        .sidebar nav ul li a i { margin-right: 15px; width: 20px; text-align: center; color: #777; transition: color 0.2s ease; font-style: normal; /* Reset italic if using <i> for icons */ }
        .sidebar nav ul li a:hover { background-color: rgba(255, 255, 255, 0.05); color: #ffffff; transform: translateX(3px); }
        .sidebar nav ul li a:hover i { color: #58a6ff; }
        .sidebar nav ul li a.active { background-color: rgba(88, 166, 255, 0.15); color: #ffffff; font-weight: 600; }
        .sidebar nav ul li a.active i { color: #58a6ff; }
        .sidebar nav ul li a.active::before { content: ''; position: absolute; left: 0; top: 5px; bottom: 5px; width: 4px; background-color: #58a6ff; border-radius: 0 4px 4px 0; }
        
        /* Overlay para o menu mobile */
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 99; display: none; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .menu-overlay.is-active { display: block; opacity: 1; }
        
        /* --- Conteúdo Principal Wrapper --- */
        .main-container { flex: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; width: calc(100% - 240px); }

        /* --- Barra Superior --- */
        .top-bar { background-color: #1e1e1e; padding: 15px 30px; display: flex; justify-content: flex-end; align-items: center; border-bottom: 1px solid #333; height: 65px; flex-shrink: 0; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); z-index: 5; }
        .login-placeholder { width: 36px; height: 36px; background-color: #444; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #e0e0e0; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .login-placeholder:hover { transform: scale(1.1); box-shadow: 0 0 10px rgba(88, 166, 255, 0.5); }
        .menu-toggle-btn { display: none; /* Escondido por padrão */ background: none; border: none; color: #e0e0e0; cursor: pointer; padding: 5px; }
        .menu-toggle-btn svg { width: 28px; height: 28px; }

        /* --- Área de Conteúdo Principal --- */
        .content-area { flex: 1; padding: 35px; overflow-y: auto; background-color: #121212; }
        .content-section { display: none; /* Começa escondido */ }
        .content-section.active { display: block; animation: contentFadeInUp 0.5s ease forwards; }
        @keyframes contentFadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Estilos Comuns Seções --- */
        .section-title { font-size: 1.5em; color: #e0e0e0; margin-bottom: 25px; padding-bottom: 10px; border-bottom: 1px solid #444; font-weight: 600; }
        .summary-section { display: flex; flex-wrap: wrap; gap: 30px; margin-bottom: 35px; }
        .summary-card, .planning-summary-card, .report-card { background-color: #282828; padding: 25px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4); border: 1px solid #444; flex: 1; min-width: 200px; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .summary-card:hover, .planning-summary-card:hover, .report-card:hover { transform: translateY(-5px); box-shadow: 0 12px 35px rgba(0, 0, 0, 0.5); }
        .card-title { font-size: 1.1em; color: #b0b0b0; margin-bottom: 15px; font-weight: 600; }

        /* --- Dashboard Específico --- */
        .balance-card .balance-display { font-size: 2.5em; font-weight: 700; color: #ffffff; margin-bottom: 8px; }
        .balance-card .entry-exit-summary { font-size: 0.9em; color: #a0a0a0; margin-bottom: 20px; }
        .add-button { background: linear-gradient(135deg, #58a6ff, #3b82f6); color: #ffffff; border: none; padding: 12px 25px; font-size: 0.95em; font-weight: 600; border-radius: 8px; cursor: pointer; box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3); transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease; display: inline-flex; align-items: center; gap: 8px; }
        .add-button:hover { background: linear-gradient(135deg, #4a9ae1, #2563eb); transform: translateY(-3px) scale(1.03); box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4); }
        .add-button svg { fill: currentColor; }
        .graph-card .graph-container { position: relative; height: 160px; width: 100%; }

        /* --- Histórico / Tabelas --- */
        .data-table-container { background-color: #282828; padding: 25px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4); border: 1px solid #444; margin-bottom: 30px; overflow-x: auto; }
        .data-table-container:last-child { margin-bottom: 0; }
        .monthly-table-container h2 { font-size: 1.3em; margin-bottom: 20px; color: #e0e0e0; font-weight: 600; border-bottom: 1px solid #555; padding-bottom: 10px; }
        .data-table { width: 100%; border-collapse: collapse; min-width: 600px; /* Garante que a tabela tenha uma largura mínima antes de rolar */ }
        .data-table thead { border-bottom: 2px solid #555; }
        .data-table th { padding: 12px 15px; text-align: left; color: #b0b0b0; font-weight: 600; font-size: 0.85em; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; }
        .data-table tbody tr { border-bottom: 1px solid #383838; transition: background-color 0.2s ease; }
        .data-table tbody tr:last-child { border-bottom: none; }
        .data-table tbody tr:hover:not(.paid) { background-color: rgba(255, 255, 255, 0.04); }
        .data-table td { padding: 15px; text-align: left; font-size: 0.9em; color: #c0c0c0; vertical-align: middle; }
        .data-table td.amount { font-weight: 600; }
        .income .amount-value { color: #3fb950; } .expense .amount-value { color: #f85149; }
        .type span { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 0.8em; font-weight: 600; }
        .type .type-income { background-color: rgba(63, 185, 80, 0.2); color: #5ae470; }
        .type .type-expense { background-color: rgba(248, 81, 73, 0.2); color: #ff807a; }
        td.actions button { background: none; border: none; color: #888; cursor: pointer; font-size: 1.2em; padding: 5px; transition: color 0.2s ease, transform 0.2s ease; margin-left: 5px; }
        td.actions button:hover { color: #f85149; transform: scale(1.2); }
        .no-data-message { padding: 20px; text-align: center; color: #888; font-style: italic; margin-top: 10px; font-size: 0.9em; }

        /* --- Planejamento --- */
        .planning-summary-section { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; background-color: #282828; padding: 20px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.35); border: 1px solid #444; }
        .planning-summary-card { background-color: #333; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px; text-align: center; border: 1px solid #555; }
        .planning-summary-card h3 { font-size: 1.0em; color: #b0b0b0; margin-bottom: 8px; font-weight: 600;}
        .planning-summary-card .value { font-size: 1.6em; font-weight: 700; margin-top: 5px; display: block; }
        .planning-summary-card .value.positive { color: #3fb950; } .planning-summary-card .value.negative { color: #f85149; } .planning-summary-card .value.neutral { color: #e0e0e0; } .planning-summary-card .value.percent { font-size: 1.4em; }
        .planning-table-section h3 { font-size: 1.3em; margin-bottom: 15px; color: #e0e0e0; font-weight: 600; }
        .planning-table-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;}
        .clear-plan-button { background-color: #666; color: #e0e0e0; border: none; padding: 10px 20px; font-size: 0.9em; font-weight: 600; border-radius: 8px; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease; }
        .clear-plan-button:hover { background-color: #e74c3c; color: #fff; transform: translateY(-2px); }
        .planning-table td.plan-income-col, .planning-table td.plan-expense-col { font-weight: normal; color: #a0a0a0; }
        .planning-table td.plan-income-col.has-value { color: #3fb950; font-weight: 500;} .planning-table td.plan-expense-col.has-value { color: #f85149; font-weight: 500;}

        /* --- Poupança --- */
        #poupanca-content .goal-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 25px; background-color: #282828; padding: 15px 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 1px solid #444; }
        #poupanca-content .goal-progress-info { display: flex; align-items: center; gap: 15px; flex-grow: 1; min-width: 250px; }
        #poupanca-content .progress-bar-container { width: 150px; height: 10px; background-color: #444; border-radius: 5px; overflow: hidden; }
        #poupanca-content #goal-progress-bar { height: 100%; width: 0%; background-color: #58a6ff; border-radius: 5px; transition: width 0.5s ease; }
        #poupanca-content #goal-progress-percent { font-weight: bold; color: #58a6ff; }
        #poupanca-content #goal-time-elapsed { font-size: 0.9em; color: #a0a0a0; white-space: nowrap; }
        #poupanca-content #add-goal-btn { flex-shrink: 0; }
        #poupanca-content .goal-details { background-color: #282828; padding: 20px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 1px solid #444; }
        #poupanca-content .goal-details h3 { font-size: 1.4em; color: #ffffff; margin-bottom: 15px; }
        #poupanca-content .goal-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; font-size: 0.95em; }
        #poupanca-content .goal-info span { color: #a0a0a0; }
        #poupanca-content .goal-info strong { color: #e0e0e0; margin-left: 5px; }
        #poupanca-content .savings-grid-container { background-color: #282828; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 1px solid #444; margin-bottom: 30px;}
        #poupanca-content .savings-grid-container h4 { font-size: 1.1em; color: #b0b0b0; margin-bottom: 15px; font-weight: 600; }
        #poupanca-content .savings-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 8px; max-width: 500px; margin: 0 auto; }
        #poupanca-content .savings-square { background-color: #444; border: 1px solid #555; border-radius: 4px; aspect-ratio: 1 / 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 1em; font-weight: bold; color: #ccc; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease; user-select: none; position: relative; padding: 2px; line-height: 1.1; text-align: center; }
        #poupanca-content .savings-square[data-value-length="3"] { font-size: 0.9em; }
        #poupanca-content .savings-square[data-value-length="4"] { font-size: 0.8em; }
        #poupanca-content .savings-square[data-value-length="5"] { font-size: 0.7em; }
        #poupanca-content .savings-square:hover:not(.saved) { background-color: #555; transform: scale(1.05); }
        #poupanca-content .savings-square.saved { background-color: #3fb950; border-color: #5ae470; color: rgba(255, 255, 255, 0.7); cursor: pointer; }
        #poupanca-content .savings-square.saved:hover { background-color: #48c75a; transform: scale(1.05); }
        #poupanca-content .savings-square.saved::after { content: '✔'; font-size: 1.8em; color: #ffffff; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0.9; pointer-events: none; }
        #poupanca-content .goal-actions { text-align: right; margin-top: 20px; }
        #poupanca-content #remove-goal-btn { background-color: #c0392b; color: white; border: none; padding: 10px 20px; font-size: 0.9em; font-weight: 600; border-radius: 8px; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease; }
        #poupanca-content #remove-goal-btn:hover { background-color: #a93226; transform: translateY(-2px); }
        #poupanca-content .no-goal-message, #poupanca-content .elite-message { padding: 30px; text-align: center; background-color: #282828; border-radius: 10px; margin-top: 20px; border: 1px solid #444; }
        #poupanca-content .no-goal-message p { color: #a0a0a0; margin-bottom: 15px; }
        #poupanca-content .elite-message { color: #f39c12; border-color: #f39c12; display: none; }

        /* --- Contas a Pagar --- */
        #contas-pagar-content .contas-table-container { margin-top: 0; }
        #contas-pagar-content .contas-table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;}
        .contas-table tbody tr.paid { background-color: rgba(63, 185, 80, 0.1); text-decoration: line-through; }
        .contas-table tbody tr.paid td { color: #777; }
        .contas-table tbody tr.paid .amount { color: #5a9e63; text-decoration: line-through; }
        .contas-table tbody tr.overdue { background-color: rgba(248, 81, 73, 0.1); border-left: 3px solid #f85149; }
        .contas-table tbody tr.due-soon { background-color: rgba(243, 156, 18, 0.1); border-left: 3px solid #f39c12; }
        .contas-table td.due-date.overdue-text { color: #ff807a; font-weight: bold; }
        .contas-table td.due-date.due-soon-text { color: #f5b041; font-weight: bold; }
        .mark-paid-btn { color: #3fb950 !important; }
        .mark-paid-btn:hover { color: #5ae470 !important; transform: scale(1.2); }
        .delete-conta-btn:hover { color: #f85149 !important; }
        .download-pdf-btn { color: #58a6ff !important; /* Cor para o novo botão */ }
        .download-pdf-btn:hover { color: #82baff !important; transform: scale(1.2); }

        /* --- Pessoas Devendo (Nova Seção) --- */
        #pessoas-devendo-content .data-table-container h3 { font-size: 1.3em; color: #e0e0e0; font-weight: 600; }
        .pessoas-devendo-table tbody tr.paid { background-color: rgba(63, 185, 80, 0.1); }
        .pessoas-devendo-table tbody tr.paid td { color: #777; }
        .pessoas-devendo-table tbody tr.paid .amount { color: #5a9e63; }
        .pessoas-devendo-table tbody tr.overdue { background-color: rgba(243, 156, 18, 0.08); border-left: 3px solid #f39c12; }
        .mark-received-btn { color: #3fb950 !important; } /* Pagar o restante */
        .mark-received-btn:hover { color: #5ae470 !important; transform: scale(1.2); }
        .add-payment-btn { color: #f39c12 !important; } /* Pagamento parcial */
        .add-payment-btn:hover { color: #f5b041 !important; transform: scale(1.2); }
        .delete-debtor-btn:hover { color: #f85149 !important; }
        .amount-breakdown { font-size: 0.8em; color: #999; display: block; }
        .paid .amount-breakdown { color: #777; }

        /* --- Relatório --- */
        #relatorio-content h3.report-month-title { font-size: 1.3em; color: #e0e0e0; margin-bottom: 20px; font-weight: 600; border-bottom: 1px solid #555; padding-bottom: 10px; }
        .report-section-container { display: flex; flex-direction: column; gap: 30px; }
        .report-summary-section { display: flex; flex-wrap: wrap; gap: 30px; }
        .report-card h4 { font-size: 1.1em; color: #b0b0b0; margin-bottom: 15px; font-weight: 600; text-align: center; }
        .report-chart-container { position: relative; width: 100%; min-height: 280px; flex-grow: 1; display: flex; align-items: center; justify-content: center;}
        .report-in-out-container { display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 15px; flex-grow: 1; text-align: center; padding: 20px 0; }
        .report-in-out-container div { margin-bottom: 10px; }
        .report-in-out-container .value { font-size: 1.8em; font-weight: 700; display: block; }
        .report-in-out-container .value.income { color: #3fb950; }
        .report-in-out-container .value.expense { color: #f85149; }
        .report-in-out-container span { color: #a0a0a0; font-size: 0.9em; }
        .report-evolution-container { position: relative; width: 100%; height: 300px; }

        /* --- Modal --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.7); align-items: center; justify-content: center; animation-duration: 0.4s; animation-timing-function: ease; }
        @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modalSlideIn { from { transform: translateY(-40px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        @keyframes modalFadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes modalSlideOut { from { transform: translateY(0) scale(1); opacity: 1; } to { transform: translateY(40px) scale(0.95); opacity: 0; } }
        .modal-content { background-color: #333333; color: #e0e0e0; margin: auto; padding: 35px 45px; border-radius: 15px; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6); width: 90%; max-width: 550px; position: relative; border: 1px solid #555; }
        .close-modal-btn { color: #aaa; position: absolute; top: 18px; right: 25px; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s ease, transform 0.2s ease; }
        .close-modal-btn:hover, .close-modal-btn:focus { color: #ffffff; transform: rotate(90deg); }
        .modal h2 { margin-bottom: 30px; text-align: center; color: #ffffff; font-size: 1.6em; font-weight: 600; }
        .modal label { display: block; margin-bottom: 8px; font-weight: 500; color: #b0b0b0; font-size: 0.9em; }
        .modal input[type="date"], .modal input[type="text"], .modal input[type="number"], .modal select { width: 100%; padding: 12px 14px; margin-bottom: 18px; border: 1px solid #555; border-radius: 8px; font-size: 1em; transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease; background-color: #444; color: #e0e0e0; }
        .modal input:focus, .modal select:focus { border-color: #58a6ff; box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2); outline: none; background-color: #505050; }
        .modal input::placeholder { color: #888; opacity: 1; }
        .modal small { display: block; margin-top: -12px; margin-bottom: 18px; color: #888; font-size: 0.85em;}
        .modal .form-group { margin-bottom: 18px; }
        .modal .type-selection, .modal .deadline-selection { display: flex; flex-direction: column; gap: 10px; margin-bottom: 25px; }
        .modal .deadline-selection > label:first-child { margin-bottom: 8px; }
        .modal .type-selection label, .modal .deadline-selection label:not(:first-child) { display: flex; align-items: center; cursor: pointer; padding: 12px 15px; border: 1px solid #555; border-radius: 8px; transition: background-color 0.3s ease, border-color 0.3s ease, transform 0.2s ease; justify-content: flex-start; font-weight: 500; background-color: #444; }
        .modal .type-selection label:hover, .modal .deadline-selection label:not(:first-child):hover { background-color: #505050; transform: translateY(-2px); }
        .modal .type-selection input[type="radio"], .modal .deadline-selection input[type="radio"] { margin-right: 10px; accent-color: #58a6ff; display: inline-block !important; width: auto; }
        .modal .type-selection input[type="radio"]:checked + span, .modal .deadline-selection input[type="radio"]:checked + span { font-weight: 600; }
        .modal .type-selection label:has(input[value="income"]:checked), .modal .deadline-selection label:has(input:checked) { border-color: #58a6ff; background-color: rgba(88, 166, 255, 0.15); color: #ffffff; }
        .modal .type-selection label:has(input[value="expense"]:checked) { border-color: #f85149; background-color: rgba(248, 81, 73, 0.25); color: #ff807a; }
        #transaction-form button[type="submit"] { background: linear-gradient(135deg, #3fb950, #33a043); } #transaction-form button[type="submit"]:hover { background: linear-gradient(135deg, #33a043, #2a8a36); }
        #plan-item-form button[type="submit"] { background: linear-gradient(135deg, #f39c12, #e67e22); } #plan-item-form button[type="submit"]:hover { background: linear-gradient(135deg, #e67e22, #d35400); }
        #add-goal-form button[type="submit"] { background: linear-gradient(135deg, #3498db, #2980b9); } #add-goal-form button[type="submit"]:hover { background: linear-gradient(135deg, #2980b9, #1f618d); }
        #add-conta-form button[type="submit"] { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        #add-conta-form button[type="submit"]:hover { background: linear-gradient(135deg, #c0392b, #a93226); }
        #add-pessoa-devendo-form button[type="submit"] { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        #add-pessoa-devendo-form button[type="submit"]:hover { background: linear-gradient(135deg, #27ae60, #229954); }
        #payment-form button[type="submit"] { background: linear-gradient(135deg, #f39c12, #e67e22); }
        #payment-form button[type="submit"]:hover { background: linear-gradient(135deg, #e67e22, #d35400); }
        .modal button[type="submit"] { color: white; padding: 14px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em; font-weight: 600; width: 100%; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease; margin-top: 15px; }
        .modal button[type="submit"]:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4); }

        /* Estilos para o Modal de Devedor (Itens Múltiplos) */
        #debt-items-container {
            border: 1px solid #555; padding: 15px; border-radius: 8px; margin-bottom: 20px;
            max-height: 200px; overflow-y: auto;
        }
        .debt-item { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .debt-item-description { flex-grow: 1; }
        .debt-item-amount { width: 120px; }
        .debt-item .modal-input { margin-bottom: 0; }
        .remove-debt-item-btn {
            background: #666; color: #e0e0e0; border: none; border-radius: 50%; width: 28px; height: 28px;
            cursor: pointer; font-weight: bold; font-size: 1.2em; line-height: 1; padding-bottom: 2px;
            transition: background-color 0.2s; flex-shrink: 0;
        }
        .remove-debt-item-btn:hover { background: #c0392b; }
        .add-debt-item-btn {
            background-color: transparent; border: 1px dashed #777; color: #a0a0a0;
            padding: 8px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: 600;
            transition: all 0.2s; margin-top: 5px;
        }
        .add-debt-item-btn:hover { background-color: #555; color: #fff; border-color: #888; }
        #debtor-total-amount-display {
            text-align: right; font-size: 1.2em; font-weight: bold; margin-top: -10px; margin-bottom: 20px;
            color: #3fb950;
        }
        /* Modal de Pagamento Parcial */
        .payment-info { background-color: #444; padding: 10px 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .payment-info strong { color: #f39c12; }

        /* --- Toast Notification --- */
        .toast-notification { position: fixed; bottom: 25px; right: 25px; background-color: #282828; color: #e0e0e0; padding: 14px 22px; border-radius: 8px; border-left: 4px solid #58a6ff; box-shadow: 0 6px 20px rgba(0,0,0,0.4); z-index: 1001; opacity: 0; visibility: hidden; transition: opacity 0.4s ease, visibility 0.4s ease, transform 0.4s ease; transform: translateX(20px); }
        .toast-notification.show { opacity: 1; visibility: visible; transform: translateX(0); }

        /* Estilo para os botões de data e input de data */
        .date-buttons { display: flex; gap: 10px; margin-bottom: 10px; }
        .date-button { flex: 1; padding: 12px; border: 1px solid #555; border-radius: 8px; background-color: #444; color: #e0e0e0; cursor: pointer; transition: all 0.3s ease; font-size: 0.9em; text-align: center; }
        .date-button:hover { background-color: #505050; transform: translateY(-2px); }
        .date-button.active { border-color: #58a6ff; background-color: rgba(88, 166, 255, 0.15); color: #ffffff; }
        .modal input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.8) brightness(1.1); cursor: pointer; padding: 2px; margin-left: 5px; opacity: 0.75; transition: opacity 0.2s ease; }
        .modal input[type="date"]::-webkit-calendar-picker-indicator:hover { opacity: 1; }
        
        /* CSS para o Template da Fatura (PDF) */
        #pdf-invoice-template {
            position: absolute; left: -9999px; /* Esconde fora da tela */
            top: 0; width: 800px; background-color: #ffffff; color: #333;
            font-family: Arial, sans-serif; padding: 40px; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .invoice-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; }
        .invoice-header .logo { font-size: 24px; font-weight: bold; }
        .invoice-header .status-paid { background-color: #e8f5e9; color: #388e3c; padding: 8px 16px; border-radius: 16px; font-weight: bold; }
        .invoice-header .status-unpaid { background-color: #fff3e0; color: #f57c00; padding: 8px 16px; border-radius: 16px; font-weight: bold; }
        .invoice-title { font-size: 36px; font-weight: bold; margin-bottom: 10px; color: #000; }
        .invoice-details { display: flex; justify-content: space-between; margin-bottom: 40px; }
        .invoice-details .detail-block { font-size: 14px; line-height: 1.5; }
        .invoice-details .detail-block .label { color: #888; text-transform: uppercase; font-size: 12px; }
        .invoice-details .bill-to { text-align: right; }
        .invoice-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        .invoice-table thead { border-bottom: 2px solid #ddd; }
        .invoice-table th { padding: 10px 0; text-align: left; color: #888; font-size: 12px; text-transform: uppercase; }
        .invoice-table th:last-child { text-align: right; }
        .invoice-table tbody tr td { padding: 15px 0; border-bottom: 1px solid #eee; }
        .invoice-table tbody tr:last-child td { border-bottom: none; }
        .invoice-table .item-description { font-weight: bold; }
        .invoice-table .item-amount { text-align: right; font-weight: bold; font-size: 16px; }
        .invoice-totals { display: flex; justify-content: flex-end; }
        .invoice-totals table { width: 300px; text-align: right; line-height: 1.8; }
        .invoice-totals .subtotal-row td { font-size: 14px; }
        .invoice-totals .total-row td { font-weight: bold; font-size: 22px; padding-top: 10px; border-top: 2px solid #333; }
        #invoice-payments-section { margin-top: 40px; }
        #invoice-payments-section h3 { font-size: 16px; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-bottom: 10px; }
        #invoice-payments-table { width: 100%; text-align: left; font-size: 14px; line-height: 1.6; }


        @media (max-width: 800px) {
            body { display: block; }
            .sidebar { position: fixed; top: 0; left: 0; height: 100%; z-index: 1100; transform: translateX(-100%); box-shadow: 4px 0 20px rgba(0,0,0,0.5); }
            .sidebar.is-open { transform: translateX(0); }
            .main-container { width: 100%; transform: translateX(0); }
            .top-bar { justify-content: space-between; padding: 15px 20px; }
            .menu-toggle-btn { display: block; }
            .content-area { padding: 20px 15px; }
            .section-title { font-size: 1.3em; }
            .summary-section, .report-summary-section { gap: 15px; }
            .summary-card, .planning-summary-card, .report-card { padding: 20px; min-width: 100%; }
            .balance-card .balance-display { font-size: 2em; }
            .data-table-container { padding: 15px; }
            .modal-content { width: 95%; padding: 25px 20px; }
            .modal h2 { font-size: 1.4em; }
            .date-buttons { flex-wrap: wrap; }
        }
    </style>
</head>
<body>

    <!-- Menu Lateral -->
    <aside class="sidebar">
        <h2>Finance App</h2>
        <nav>
             <ul>
                 <li><a href="#" class="nav-link active" data-section="dashboard"><i>📊</i> Dashboard</a></li>
                 <li><a href="#" class="nav-link" data-section="futuros-gastos"><i>🔮</i> Planejamento</a></li>
                 <li><a href="#" class="nav-link" data-section="poupanca"><i>🐷</i> Poupança</a></li>
                 <li><a href="#" class="nav-link" data-section="contas-pagar"><i>🧾</i> Contas a pagar</a></li>
                 <li><a href="#" class="nav-link" data-section="pessoas-devendo"><i>🤝</i> Pessoas Devendo</a></li>
                 <li><a href="#" class="nav-link" data-section="relatorio"><i>📈</i> Relatório</a></li>
                 <li><a href="#" class="nav-link" data-section="objetivos"><i>🎯</i> Objetivos</a></li>
            </ul>
        </nav>
    </aside>

    <!-- Overlay para o menu mobile -->
    <div class="menu-overlay"></div>

    <!-- Wrapper Principal -->
    <div class="main-container">
        <!-- Barra Superior -->
        <header class="top-bar">
            <button id="menu-toggle-btn" class="menu-toggle-btn" aria-label="Abrir menu">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
            </button>
            <div class="login-placeholder">U</div>
        </header>

        <!-- Área de Conteúdo Principal -->
        <main class="content-area">
            <!-- ====================== Seção Dashboard ====================== -->
            <div id="dashboard-content" class="content-section active">
                <h2 class="section-title">Dashboard</h2>
                <section class="summary-section">
                    <div class="summary-card balance-card">
                        <h3 class="card-title">Resumo financeiro</h3>
                        <div class="balance-display" id="balance-value">R$ 0,00</div>
                        <div class="entry-exit-summary" id="entry-exit-summary-text">0 entradas / 0 saídas</div>
                        <button id="add-transaction-btn" class="add-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="18" height="18"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg> Adicionar Gasto</button>
                    </div>
                    <div class="summary-card graph-card">
                        <h3 class="card-title">Saldo Diário (Últimos 30 dias)</h3>
                        <div class="graph-container"><canvas id="historyChart"></canvas></div>
                    </div>
                </section>
                <section id="history-section" class="data-table-container">
                     <h3 class="section-title" style="margin-bottom: 20px; border: none; padding-bottom: 0;">Histórico de Movimentações</h3>
                     <div class="monthly-table-container" id="history-placeholder" style="display: none;">
                        <p class="no-data-message">Nenhuma movimentação registrada ainda.</p>
                     </div>
                </section>
            </div>

            <!-- ====================== Seção Planejamento ====================== -->
            <div id="futuros-gastos-content" class="content-section">
                 <h2 class="section-title">Planejamento Futuro</h2>
                <section class="planning-summary-section">
                    <div class="planning-summary-card"><h3>Saldo Planejado</h3><span class="value neutral" id="plan-balance">R$ 0,00</span></div>
                    <div class="planning-summary-card"><h3>% Ganho</h3><span class="value positive percent" id="plan-profit-pct">0,0%</span></div>
                    <div class="planning-summary-card"><h3>% Despesa</h3><span class="value negative percent" id="plan-expense-pct">0,0%</span></div>
                    <div class="planning-summary-card"><h3>Gasto Total</h3><span class="value negative" id="plan-total-expense">R$ 0,00</span></div>
                    <div class="planning-summary-card"><h3>Ganho Total</h3><span class="value positive" id="plan-total-income">R$ 0,00</span></div>
                </section>
                <section class="planning-table-section data-table-container">
                    <div class="planning-table-actions">
                        <h3>Itens do Plano</h3>
                        <button id="add-plan-item-btn" class="add-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="18" height="18"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"></path></svg> Adicionar ao Plano</button>
                    </div>
                    <table class="planning-table data-table">
                        <thead><tr><th>O que</th><th>Valor</th><th>Tipo</th><th>Entrou</th><th>Saiu</th><th>Total Plano</th><th>Ações</th></tr></thead>
                        <tbody id="planning-tbody">
                            <tr id="no-planning-placeholder" style="display: none;"><td colspan="7" class="no-data-message">Nenhum item no plano.</td></tr>
                        </tbody>
                    </table>
                    <div style="text-align: right; margin-top: 20px;">
                        <button id="clear-plan-btn" class="clear-plan-button">Limpar Plano</button>
                    </div>
                </section>
            </div>

            <!-- ====================== Seção Poupança (Objetivo) ====================== -->
            <div id="poupanca-content" class="content-section">
                <h2 class="section-title">Minha Poupança / Objetivo</h2>
                <div class="goal-header">
                    <div class="goal-progress-info">
                        <div class="progress-bar-container" title="Progresso"><div id="goal-progress-bar"></div></div>
                        <span id="goal-progress-percent">--%</span>
                        <span id="goal-time-elapsed"></span>
                    </div>
                    <button id="add-goal-btn" class="add-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="18" height="18"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"></path></svg> Definir Objetivo</button>
                </div>
                <div id="no-goal-message" class="no-goal-message" style="display: none;"><p>Você ainda não definiu um objetivo.</p><p>Clique em "Definir Objetivo"!</p></div>
                <div id="elite-message" class="elite-message" style="display: none;">⚠️ Objetivos > R$ 50.000 requerem versão Elite.</div>
                <div id="goal-active-details" style="display: none;">
                    <div class="goal-details"><h3 id="goal-description">---</h3><div class="goal-info"><div>Meta: <strong id="goal-target-amount">R$ 0,00</strong></div><div>Salvo: <strong id="goal-current-saved">R$ 0,00</strong></div><div>Início: <strong id="goal-start-date">--/--/----</strong></div><div>Estimativa Fim: <strong id="goal-estimated-completion">--/--/----</strong></div></div></div>
                    <div class="savings-grid-container"><h4>Marque os valores poupados:</h4><div id="savings-grid" class="savings-grid"></div></div>
                    <div class="goal-actions"><button id="remove-goal-btn" title="Remove o objetivo atual">Remover Objetivo</button></div>
                 </div>
            </div>

            <!-- ====================== Seção Contas a Pagar ====================== -->
            <div id="contas-pagar-content" class="content-section">
                <h2 class="section-title">Contas a Pagar</h2>
                <button id="add-conta-btn" class="add-button" style="margin-bottom: 25px;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="18" height="18"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"></path></svg>
                    Adicionar Conta/Dívida
                </button>
                <div class="contas-table-container data-table-container">
                    <div class="contas-table-header">
                         <h3>Contas Pendentes e Pagas</h3>
                    </div>
                    <table class="contas-table data-table">
                        <thead><tr><th>Descrição</th><th>Valor</th><th>Vencimento</th><th>Status</th><th>Ações</th></tr></thead>
                        <tbody id="contas-tbody"></tbody>
                    </table>
                    <div id="no-contas-message" class="no-data-message" style="display: none;">
                        Nenhuma conta registrada.
                    </div>
                </div>
            </div>

            <!-- ====================== Seção Pessoas Devendo ====================== -->
            <div id="pessoas-devendo-content" class="content-section">
                <h2 class="section-title">Pessoas Devendo a Mim</h2>
                <button id="add-pessoa-devendo-btn" class="add-button" style="margin-bottom: 25px;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="18" height="18"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"></path></svg>
                    Adicionar Devedor
                </button>
                <div class="data-table-container">
                    <div class="pessoas-devendo-table-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                         <h3>Lista de Devedores</h3>
                    </div>
                    <table class="pessoas-devendo-table data-table">
                        <thead><tr><th>Nome</th><th>Valor (Restante / Total)</th><th>Data Empréstimo</th><th>Status</th><th>Ações</th></tr></thead>
                        <tbody id="pessoas-devendo-tbody"></tbody>
                    </table>
                    <div id="no-pessoas-devendo-message" class="no-data-message" style="display: none;">
                        Ninguém te devendo no momento. 🎉
                    </div>
                </div>
            </div>

            <!-- ====================== Seção Relatório ====================== -->
            <div id="relatorio-content" class="content-section">
                <h2 class="section-title">Relatório Financeiro</h2>
                <h3 id="report-current-month" class="report-month-title">Mês Atual</h3>
                <div class="report-section-container">
                    <section class="report-summary-section">
                        <div class="report-card">
                            <h4>Top 3 Despesas (Mês)</h4>
                            <div class="report-chart-container">
                                <canvas id="top-expenses-chart"></canvas>
                                <p id="no-expenses-message" class="no-data-message" style="display: none;">Nenhuma despesa registrada neste mês.</p>
                            </div>
                        </div>
                        <div class="report-card">
                             <h4>Entradas vs Saídas (Mês)</h4>
                            <div class="report-in-out-container">
                                <div>
                                    <span>Entradas</span>
                                    <strong id="report-current-month-income" class="value income">R$ 0,00</strong>
                                </div>
                                <div>
                                    <span>Saídas</span>
                                    <strong id="report-current-month-expense" class="value expense">R$ 0,00</strong>
                                </div>
                            </div>
                        </div>
                    </section>
                    <section class="report-card">
                        <h4>Evolução do Patrimônio (Geral)</h4>
                        <div class="report-evolution-container">
                             <canvas id="net-worth-chart"></canvas>
                             <p id="no-history-message" class="no-data-message" style="display: none;">Dados insuficientes para exibir a evolução.</p>
                        </div>
                    </section>
                 </div>
            </div>

            <!-- ====================== Seção Objetivos (Placeholder) ====================== -->
            <div id="objetivos-content" class="content-section">
                <h2 class="section-title">Objetivos</h2>
                <p class="no-data-message">Funcionalidade de objetivos avançados em desenvolvimento.</p>
            </div>
        </main>
    </div>
    
    <!-- Template da Fatura para PDF -->
    <div id="pdf-invoice-template">
        <div class="invoice-header">
            <div class="logo">Finance App</div>
            <div id="invoice-status" class="status-unpaid">Em Aberto</div>
        </div>
        <h1 class="invoice-title" id="invoice-number">#INV-000000</h1>
        <div class="invoice-details">
            <div class="detail-block">
                <div class="label">Data Emissão</div>
                <div id="invoice-date-issued">--/--/----</div>
            </div>
            <div class="detail-block bill-to">
                <div class="label">Cobrança Para</div>
                <div id="invoice-bill-to-name">Nome do Devedor</div>
            </div>
        </div>
        <table class="invoice-table">
            <thead>
                <tr>
                    <th>Descrição</th>
                    <th class="item-amount">Total</th>
                </tr>
            </thead>
            <tbody id="invoice-items-body">
                <!-- Itens serão inseridos aqui dinamicamente -->
            </tbody>
        </table>
        <div class="invoice-totals">
            <table>
                <tbody>
                    <tr class="subtotal-row"><td>Subtotal</td><td id="invoice-subtotal">R$ 0,00</td></tr>
                    <tr class="subtotal-row"><td>Valor Pago</td><td id="invoice-paid-amount">R$ 0,00</td></tr>
                    <tr class="total-row"><td>Restante</td><td id="invoice-total">R$ 0,00</td></tr>
                </tbody>
            </table>
        </div>
        <div id="invoice-payments-section">
            <h3>Histórico de Pagamentos</h3>
            <table id="invoice-payments-table">
                <!-- Pagamentos serão inseridos aqui -->
            </table>
        </div>
    </div>


    <!-- ====================== Modais ====================== -->
    <div id="add-transaction-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" data-modal-id="add-transaction-modal">&times;</span>
            <h2>Adicionar Movimentação</h2>
            <form id="transaction-form" novalidate>
                <div class="form-group">
                    <label for="tx-date">Data:</label>
                    <div class="date-buttons">
                        <button type="button" class="date-button yesterday" data-days="-1">Ontem</button>
                        <button type="button" class="date-button today active" data-days="0">Hoje</button>
                        <button type="button" class="date-button tomorrow" data-days="1">Amanhã</button>
                        <button type="button" class="date-button other" data-days="7">+7 dias</button>
                    </div>
                    <input type="date" id="tx-date" required>
                </div>
                <div class="form-group">
                    <label for="tx-description">Descrição:</label>
                    <input type="text" id="tx-description" placeholder="Ex: Salário" required maxlength="100">
                </div>
                <div class="form-group">
                    <label for="tx-amount">Valor:</label>
                    <input type="number" id="tx-amount" step="0.01" placeholder="0.00" required min="0.01">
                </div>
                <div class="type-selection">
                    <label><input type="radio" name="tx-type" value="income" required><span>💰 Entrada</span></label>
                    <label><input type="radio" name="tx-type" value="expense" checked required><span>💸 Saída</span></label>
                </div>
                <button type="submit">Adicionar</button>
            </form>
        </div>
    </div>
    <div id="add-plan-item-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" data-modal-id="add-plan-item-modal">&times;</span>
            <h2>Adicionar ao Plano</h2>
            <form id="plan-item-form" novalidate>
                <div class="form-group">
                    <label for="plan-description">O que:</label>
                    <input type="text" id="plan-description" placeholder="Ex: Investimento" required maxlength="100">
                </div>
                <div class="form-group">
                    <label for="plan-amount">Valor:</label>
                    <input type="number" id="plan-amount" step="0.01" placeholder="0.00" required min="0.01">
                </div>
                <div class="type-selection">
                    <label><input type="radio" name="plan-type" value="income" required><span>➕ Entrada</span></label>
                    <label><input type="radio" name="plan-type" value="expense" checked required><span>➖ Saída</span></label>
                </div>
                <button type="submit">Adicionar</button>
            </form>
        </div>
    </div>
    <div id="add-goal-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" data-modal-id="add-goal-modal">&times;</span>
            <h2>Definir Objetivo</h2>
            <form id="add-goal-form" novalidate>
                <div class="form-group">
                    <label for="goal-modal-description">Motivo:</label>
                    <input type="text" id="goal-modal-description" placeholder="Ex: Viagem" required maxlength="100">
                </div>
                <div class="form-group">
                    <label for="goal-modal-amount">Valor (limite R$ 50k):</label>
                    <input type="number" id="goal-modal-amount" step="0.01" placeholder="1000.00" required min="1" max="50000">
                </div>
                <div class="deadline-selection">
                    <label>Prazo:</label>
                    <label><input type="radio" name="goal-deadline" value="short" required checked><span>6 meses</span></label>
                    <label><input type="radio" name="goal-deadline" value="medium" required><span>1 ano</span></label>
                    <label><input type="radio" name="goal-deadline" value="long" required><span>3 anos</span></label>
                </div>
                <button type="submit">Criar Objetivo</button>
            </form>
        </div>
    </div>
    <div id="add-conta-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" data-modal-id="add-conta-modal">&times;</span>
            <h2>Adicionar Conta ou Dívida</h2>
            <form id="add-conta-form" novalidate>
                <div class="form-group">
                    <label for="conta-description">Descrição:</label>
                    <input type="text" id="conta-description" placeholder="Ex: Conta de Luz" required maxlength="100">
                </div>
                <div class="form-group">
                    <label for="conta-amount">Valor:</label>
                    <input type="number" id="conta-amount" step="0.01" placeholder="0.00" required min="0.01">
                </div>
                <div class="form-group">
                    <label for="conta-dueDate">Data de Vencimento:</label>
                    <div class="date-buttons">
                        <button type="button" class="date-button today" data-days="0">Hoje</button>
                        <button type="button" class="date-button tomorrow" data-days="1">Amanhã</button>
                        <button type="button" class="date-button other active" data-days="30">+30 dias</button>
                        <button type="button" class="date-button other" data-days="60">+60 dias</button>
                    </div>
                    <input type="date" id="conta-dueDate" required>
                    <small>(Padrão: 1 mês a partir de hoje)</small>
                </div>
                <button type="submit">Adicionar Conta</button>
            </form>
        </div>
    </div>
    <div id="add-pessoa-devendo-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" data-modal-id="add-pessoa-devendo-modal">&times;</span>
            <h2>Adicionar Pessoa Devendo</h2>
            <form id="add-pessoa-devendo-form" novalidate>
                <div class="form-group">
                    <label for="pessoa-devendo-nome">Nome da Pessoa:</label>
                    <input type="text" id="pessoa-devendo-nome" placeholder="Ex: João Silva" required maxlength="100">
                </div>
                <div class="form-group">
                    <label for="pessoa-devendo-date">Data do Empréstimo:</label>
                    <input type="date" id="pessoa-devendo-date" required>
                </div>

                <label>Itens da Dívida:</label>
                <div id="debt-items-container">
                    <!-- Itens serão adicionados aqui via JS -->
                </div>
                <button type="button" id="add-debt-item-btn" class="add-debt-item-btn">+ Adicionar Item</button>
                
                <div id="debtor-total-amount-display">Total: R$ 0,00</div>

                <button type="submit">Adicionar Devedor</button>
            </form>
        </div>
    </div>
    <!-- NOVO MODAL DE PAGAMENTO -->
    <div id="add-payment-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" data-modal-id="add-payment-modal">&times;</span>
            <h2>Registrar Pagamento</h2>
            <form id="payment-form" novalidate>
                <input type="hidden" id="payment-debtor-id">
                <div class="payment-info">
                    Pagando para: <strong id="payment-modal-debtor-name">---</strong>
                </div>
                <div class="form-group">
                    <label for="payment-amount">Valor do Pagamento:</label>
                    <input type="number" id="payment-amount" step="0.01" placeholder="0.00" required min="0.01">
                    <small id="payment-modal-remaining-amount">Restante: R$ 0,00</small>
                </div>
                <button type="submit">Confirmar Pagamento</button>
            </form>
        </div>
    </div>


    <!-- Toast -->
    <div id="toast-notification" class="toast-notification">Msg</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Seletores DOM Agrupados ---
            const getElement = (id) => document.getElementById(id); // Helper
            const getSelector = (selector) => document.querySelector(selector);

            // Gerais & Notificação & Mobile Menu
            const toastNotification = getElement('toast-notification');
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            const menuToggleBtn = getElement('menu-toggle-btn');
            const sidebar = getSelector('.sidebar');
            const menuOverlay = getSelector('.menu-overlay');

            const contentSections = {
                'dashboard': getElement('dashboard-content'),
                'futuros-gastos': getElement('futuros-gastos-content'),
                'poupanca': getElement('poupanca-content'),
                'contas-pagar': getElement('contas-pagar-content'),
                'pessoas-devendo': getElement('pessoas-devendo-content'),
                'relatorio': getElement('relatorio-content'),
                'objetivos': getElement('objetivos-content'),
            };

            // Dashboard
            const balanceValueEl = getElement('balance-value');
            const entryExitSummaryEl = getElement('entry-exit-summary-text');
            const addTransactionBtn = getElement('add-transaction-btn');
            const historySectionContainer = getElement('history-section');
            const historyPlaceholder = getElement('history-placeholder');
            const historyChartCanvas = getElement('historyChart');

            // Planejamento
            const planBalanceEl = getElement('plan-balance');
            const planProfitPctEl = getElement('plan-profit-pct');
            const planExpensePctEl = getElement('plan-expense-pct');
            const planTotalExpenseEl = getElement('plan-total-expense');
            const planTotalIncomeEl = getElement('plan-total-income');
            const addPlanItemBtn = getElement('add-plan-item-btn');
            const planningTbody = getElement('planning-tbody');
            const noPlanningPlaceholder = getElement('no-planning-placeholder');
            const clearPlanBtn = getElement('clear-plan-btn');

            // Poupança
            const goalProgressBar = getElement('goal-progress-bar');
            const goalProgressPercent = getElement('goal-progress-percent');
            const goalTimeElapsed = getElement('goal-time-elapsed');
            const addGoalBtn = getElement('add-goal-btn');
            const noGoalMessageDiv = getElement('no-goal-message');
            const eliteMessageDiv = getElement('elite-message');
            const goalActiveDetailsDiv = getElement('goal-active-details');
            const goalDescriptionEl = getElement('goal-description');
            const goalTargetAmountEl = getElement('goal-target-amount');
            const goalCurrentSavedEl = getElement('goal-current-saved');
            const goalStartDateEl = getElement('goal-start-date');
            const goalEstimatedCompletionEl = getElement('goal-estimated-completion');
            const savingsGridEl = getElement('savings-grid');
            const removeGoalBtn = getElement('remove-goal-btn');

            // Contas a Pagar
            const addContaBtn = getElement('add-conta-btn');
            const contasTbody = getElement('contas-tbody');
            const noContasMessage = getElement('no-contas-message');

            // Pessoas Devendo
            const addPessoaDevendoBtn = getElement('add-pessoa-devendo-btn');
            const pessoasDevendoTbody = getElement('pessoas-devendo-tbody');
            const noPessoasDevendoMessage = getElement('no-pessoas-devendo-message');
            const debtItemsContainer = getElement('debt-items-container');
            const addDebtItemBtn = getElement('add-debt-item-btn');
            const debtorTotalAmountDisplay = getElement('debtor-total-amount-display');

            // Relatório
            const reportCurrentMonthEl = getElement('report-current-month');
            const topExpensesChartCanvas = getElement('top-expenses-chart');
            const reportCurrentMonthIncomeEl = getElement('report-current-month-income');
            const reportCurrentMonthExpenseEl = getElement('report-current-month-expense');
            const netWorthChartCanvas = getElement('net-worth-chart');
            const noExpensesMessageEl = getElement('no-expenses-message');
            const noHistoryMessageEl = getElement('no-history-message');

            // Modais & Forms
            const transactionForm = getElement('transaction-form');
            const planItemForm = getElement('plan-item-form');
            const addGoalForm = getElement('add-goal-form');
            const addContaForm = getElement('add-conta-form');
            const addPessoaDevendoForm = getElement('add-pessoa-devendo-form');
            const paymentForm = getElement('payment-form'); // Novo form de pagamento

            // --- Constantes ---
            const STORAGE_KEYS = {
                transactions: 'financeTransactions_v10.7',
                planning: 'financePlanningItems_v10.7',
                goal: 'financeCurrentGoal_v10.7',
                bills: 'financeContasAPagar_v10.7',
                debtors: 'financeDebtors_v10.7' // Versão atualizada
            };
            const monthNamesPtBr = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
            const monthNamesFullPtBr = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

            // --- Estado ---
            let transactions = [];
            let planningItems = [];
            let currentGoal = null;
            let contasAPagar = [];
            let pessoasDevendo = [];
            let historyChartInstance = null;
            let topExpensesChartInstance = null;
            let netWorthChartInstance = null;

            // --- Funções Utilitárias ---
            const formatCurrency = (value) => typeof value === 'number' ? value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : 'R$ 0,00';
            const showToast = (message, duration = 3500) => {
                if (!toastNotification) return;
                toastNotification.textContent = message;
                toastNotification.className = 'toast-notification show';
                setTimeout(() => {
                   if (toastNotification) toastNotification.classList.remove('show');
                }, duration);
            };
            const escapeHtml = (unsafe) => unsafe ? unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;") : "";
            const isValidDateString = (dateString) => dateString && !isNaN(Date.parse(dateString + 'T00:00:00Z'));
            const formatDate = (dateString) => {
                if (!isValidDateString(dateString)) return '--/--/----';
                try {
                    const date = new Date(dateString + 'T00:00:00Z');
                    return date.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
                } catch (e) { console.error("Error formatting date:", dateString, e); return '--/--/----'; }
            };
            const daysBetween = (date1, date2) => {
                const oneDay = 86400000;
                const utc1 = Date.UTC(date1.getUTCFullYear(), date1.getUTCMonth(), date1.getUTCDate());
                const utc2 = Date.UTC(date2.getUTCFullYear(), date2.getUTCMonth(), date2.getUTCDate());
                return Math.round((utc1 - utc2) / oneDay);
            };

            // --- Persistência de Dados ---
            const loadData = () => {
                const loadItem = (key) => { try { return JSON.parse(localStorage.getItem(key)) || []; } catch (e) { console.error(`Error loading ${key}:`, e); return []; } };
                const loadGoal = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEYS.goal)) || null; } catch (e) { console.error('Error loading goal:', e); return null; } };
                transactions = loadItem(STORAGE_KEYS.transactions);
                planningItems = loadItem(STORAGE_KEYS.planning);
                contasAPagar = loadItem(STORAGE_KEYS.bills);
                pessoasDevendo = loadItem(STORAGE_KEYS.debtors);
                currentGoal = loadGoal();
            };
            const saveData = (key, data) => { try { localStorage.setItem(key, JSON.stringify(data)); } catch (e) { console.error(`Error saving ${key}:`, e); showToast(`Erro ao salvar dados (${key}).`); } };
            
            // --- Funções de Cálculo Core ---
            const calculateRunningBalances = () => {
                const balances = {};
                let currentBalance = 0;
                const evolutionData = [];

                const sortedTransactions = [...transactions].sort((a, b) => {
                    const timeA = isValidDateString(a.date) ? new Date(a.date + 'T00:00:00Z').getTime() : 0;
                    const timeB = isValidDateString(b.date) ? new Date(b.date + 'T00:00:00Z').getTime() : 0;
                    if (timeA === timeB) { return (a.id || 0) - (b.id || 0); }
                    return timeA - timeB;
                });

                sortedTransactions.forEach(tx => {
                    if (typeof tx.amount !== 'number' || isNaN(tx.amount)) { return; }
                    const change = (tx.type === 'income' ? tx.amount : -tx.amount);
                    currentBalance += change;
                    if (tx.id) { balances[tx.id] = currentBalance; }
                    if (isValidDateString(tx.date)) { evolutionData.push({ date: tx.date, balance: currentBalance }); }
                });
                return { transactionBalances: balances, evolutionData: evolutionData };
            };
             const groupTransactionsByMonth = () => {
                 const grouped = {};
                 transactions.forEach(tx => {
                     if (isValidDateString(tx.date)) {
                         const monthKey = tx.date.substring(0, 7);
                         if (!grouped[monthKey]) grouped[monthKey] = [];
                         grouped[monthKey].push(tx);
                     }
                 });
                 return grouped;
             };

            // --- Funções de Renderização ---

            // Dashboard: Resumo
            const renderSummary = () => {
                if (!balanceValueEl || !entryExitSummaryEl) return;
                let totalIncome = 0, totalExpense = 0, incomeCount = 0, expenseCount = 0;
                transactions.forEach(tx => {
                    if (typeof tx.amount !== 'number' || isNaN(tx.amount)) return;
                    if (tx.type === 'income') { totalIncome += tx.amount; incomeCount++; }
                    else if (tx.type === 'expense') { totalExpense += tx.amount; expenseCount++; }
                });
                balanceValueEl.textContent = formatCurrency(totalIncome - totalExpense);
                entryExitSummaryEl.textContent = `${incomeCount} entradas / ${expenseCount} saídas`;
            };

            // Dashboard: Tabela de Histórico Mensal
            const renderMonthlyTables = () => {
                if (!historySectionContainer || !historyPlaceholder) return;
                historySectionContainer.innerHTML = '';
                historyPlaceholder.style.display = 'none';

                const groupedTransactions = groupTransactionsByMonth();
                const { transactionBalances } = calculateRunningBalances();
                const months = Object.keys(groupedTransactions).sort().reverse();

                const mainTitleH3 = document.createElement('h3');
                mainTitleH3.className = 'section-title';
                mainTitleH3.style.marginBottom = '20px';
                mainTitleH3.style.border = 'none';
                mainTitleH3.style.paddingBottom = '0';
                mainTitleH3.textContent = 'Histórico de Movimentações';
                historySectionContainer.appendChild(mainTitleH3);

                if (months.length === 0) {
                    historySectionContainer.appendChild(historyPlaceholder);
                    historyPlaceholder.style.display = 'block';
                    return;
                }
                
                months.forEach(monthKey => {
                    const [year, month] = monthKey.split('-').map(Number);
                    const monthName = monthNamesFullPtBr[month - 1];
                    const monthTransactions = groupedTransactions[monthKey];
                    const monthContainer = document.createElement('div');
                    monthContainer.className = 'monthly-table-container';
                    monthContainer.id = `month-${monthKey}`;
                    monthContainer.innerHTML = `<h2>${monthName} ${year}</h2>`;
                    const table = document.createElement('table');
                    table.className = 'transactions-table data-table';
                    table.innerHTML = `<thead><tr><th>Data</th><th>Descrição</th><th>Valor</th><th>Tipo</th><th>Saldo Após</th><th>Ações</th></tr></thead><tbody></tbody>`;
                    const tbody = table.querySelector('tbody');
                    monthTransactions.sort((a, b) => {
                        const timeA = isValidDateString(a.date) ? new Date(a.date + 'T00:00:00Z').getTime() : 0;
                        const timeB = isValidDateString(b.date) ? new Date(b.date + 'T00:00:00Z').getTime() : 0;
                        if (timeB === timeA) return (b.id || 0) - (a.id || 0);
                        return timeB - timeA;
                    }).forEach(tx => {
                        const tr = document.createElement('tr');
                        const isExpense = tx.type === 'expense';
                        const amountClass = isExpense ? 'expense' : 'income';
                        const typeText = isExpense ? 'Saída' : 'Entrada';
                        const typeClass = isExpense ? 'type-expense' : 'type-income';
                        const transactionBalance = transactionBalances[tx.id] ?? '---';
                        const formattedDate = formatDate(tx.date).substring(0, 5);
                        tr.innerHTML = `
                            <td>${formattedDate}</td>
                            <td>${escapeHtml(tx.description)}</td>
                            <td class="amount ${amountClass}"><span class="amount-value">${formatCurrency(tx.amount)}</span></td>
                            <td class="type"><span class="${typeClass}">${typeText}</span></td>
                            <td>${formatCurrency(transactionBalance)}</td>
                            <td class="actions"><button class="delete-btn" data-id="${tx.id}" title="Excluir">🗑️</button></td>`;
                        tbody.appendChild(tr);
                    });
                    monthContainer.appendChild(table);
                    historySectionContainer.appendChild(monthContainer);
                });
            };

            // Planejamento: Tabela e Resumo
            const renderPlanningTable = () => {
                if (!planningTbody || !noPlanningPlaceholder) return;
                planningTbody.innerHTML = '';
                noPlanningPlaceholder.style.display = 'none';
                let runningPlannedTotal = 0, totalPlannedIncome = 0, totalPlannedExpense = 0;

                if (planningItems.length === 0) {
                    noPlanningPlaceholder.style.display = 'table-row';
                } else {
                    planningItems.forEach(item => {
                        if (typeof item.amount !== 'number' || isNaN(item.amount)) return;
                        const tr = document.createElement('tr');
                        const isExpense = item.type === 'expense';
                        const typeText = isExpense ? 'Saída' : 'Entrada';
                        const typeClass = isExpense ? 'type-expense' : 'type-income';
                        const incomeValue = !isExpense ? item.amount : 0;
                        const expenseValue = isExpense ? item.amount : 0;
                        runningPlannedTotal += (isExpense ? -item.amount : item.amount);
                        if (isExpense) totalPlannedExpense += item.amount; else totalPlannedIncome += item.amount;
                        tr.innerHTML = `
                            <td>${escapeHtml(item.description)}</td><td class="amount">${formatCurrency(item.amount)}</td>
                            <td class="type"><span class="${typeClass}">${typeText}</span></td>
                            <td class="plan-income-col ${incomeValue > 0 ? 'has-value' : ''}">${formatCurrency(incomeValue)}</td>
                            <td class="plan-expense-col ${expenseValue > 0 ? 'has-value' : ''}">${formatCurrency(expenseValue)}</td>
                            <td>${formatCurrency(runningPlannedTotal)}</td>
                            <td class="actions"><button class="delete-plan-item-btn" data-id="${item.id}" title="Remover Item do Plano">🗑️</button></td>`;
                        planningTbody.appendChild(tr);
                    });
                }
                renderPlanningSummary(totalPlannedIncome, totalPlannedExpense);
            };
            const renderPlanningSummary = (totalPlannedIncome, totalPlannedExpense) => {
                if (!planBalanceEl || !planProfitPctEl || !planExpensePctEl || !planTotalExpenseEl || !planTotalIncomeEl) return;
                const plannedBalance = totalPlannedIncome - totalPlannedExpense;
                const totalMagnitude = totalPlannedIncome + totalPlannedExpense;
                let profitPercent = 0, expensePercent = 0;
                if (totalMagnitude > 0) {
                    profitPercent = (totalPlannedIncome / totalMagnitude) * 100;
                    expensePercent = (totalPlannedExpense / totalMagnitude) * 100;
                }
                planBalanceEl.textContent = formatCurrency(plannedBalance);
                planBalanceEl.className = `value ${plannedBalance > 0 ? 'positive' : plannedBalance < 0 ? 'negative' : 'neutral'}`;
                planProfitPctEl.textContent = `${profitPercent.toFixed(1)}%`;
                planExpensePctEl.textContent = `${expensePercent.toFixed(1)}%`;
                planTotalIncomeEl.textContent = formatCurrency(totalPlannedIncome);
                planTotalExpenseEl.textContent = formatCurrency(totalPlannedExpense);
            };

            // Poupança: Progresso, Detalhes e Grid
            const calculateGoalProgress = () => {
                if (!currentGoal || !currentGoal.squares || !Array.isArray(currentGoal.squares)) {
                    return { savedCount: 0, percent: 0, currentSaved: 0, daysElapsed: 0 };
                }
                let currentSaved = 0;
                currentGoal.squares.forEach((isSaved, index) => {
                    if (isSaved) { currentSaved += (currentGoal.gridValues[index] || 0); }
                });
                let percent = (currentGoal.targetAmount > 0) ? (currentSaved / currentGoal.targetAmount) * 100 : 0;
                percent = Math.max(0, Math.min(percent, 100));
                let daysElapsed = 0;
                if (currentGoal.startDate && isValidDateString(currentGoal.startDate)) {
                    try {
                        const startDate = new Date(currentGoal.startDate + 'T00:00:00Z');
                        const today = new Date();
                        const todayUTCStart = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate()));
                        daysElapsed = Math.max(0, daysBetween(todayUTCStart, startDate));
                    } catch(e) { console.error("Error calculating days elapsed:", e); }
                }
                return { percent, currentSaved, daysElapsed };
            };
            const renderGoalSection = () => {
                const hasGoal = !!currentGoal;
                if (noGoalMessageDiv) noGoalMessageDiv.style.display = hasGoal ? 'none' : 'block';
                if (goalActiveDetailsDiv) goalActiveDetailsDiv.style.display = hasGoal ? 'block' : 'none';
                if (addGoalBtn) addGoalBtn.style.display = hasGoal ? 'none' : 'inline-flex';
                if (eliteMessageDiv) eliteMessageDiv.style.display = 'none';

                if (hasGoal && currentGoal) {
                    const progress = calculateGoalProgress();
                    if (goalProgressBar) goalProgressBar.style.width = `${progress.percent}%`;
                    if (goalProgressPercent) goalProgressPercent.textContent = `${progress.percent.toFixed(0)}%`;
                    if (goalTimeElapsed) goalTimeElapsed.textContent = `Dias: ${progress.daysElapsed}`;
                    if (goalDescriptionEl) goalDescriptionEl.textContent = escapeHtml(currentGoal.description);
                    if (goalTargetAmountEl) goalTargetAmountEl.textContent = formatCurrency(currentGoal.targetAmount);
                    if (goalCurrentSavedEl) goalCurrentSavedEl.textContent = formatCurrency(progress.currentSaved);
                    if (goalStartDateEl) goalStartDateEl.textContent = formatDate(currentGoal.startDate);
                    if (goalEstimatedCompletionEl) goalEstimatedCompletionEl.textContent = formatDate(currentGoal.estimatedCompletionDate);
                    renderSavingsGrid();
                } else {
                    if (goalProgressBar) goalProgressBar.style.width = '0%';
                    if (goalProgressPercent) goalProgressPercent.textContent = '--%';
                    if (goalTimeElapsed) goalTimeElapsed.textContent = '';
                    if (savingsGridEl) savingsGridEl.innerHTML = '';
                }
            };
            const renderSavingsGrid = () => {
                 if (!savingsGridEl || !currentGoal || !currentGoal.squares || !Array.isArray(currentGoal.squares)) return;
                 savingsGridEl.innerHTML = '';
                 const gridValues = currentGoal.gridValues || [];
                 for (let i = 0; i < gridValues.length; i++) {
                    const square = document.createElement('div');
                    const value = gridValues[i] || 0;
                    const valueStr = value.toString();
                    square.className = 'savings-square';
                    square.dataset.index = i;
                    square.dataset.valueLength = valueStr.length;
                    square.textContent = valueStr;
                    square.title = `Marcar ${formatCurrency(value)}`;
                    if (currentGoal.squares[i]) { square.classList.add('saved'); square.title = `Salvo! (${formatCurrency(value)})`; }
                    savingsGridEl.appendChild(square);
                }
            };

            // Contas a Pagar: Tabela
            const renderContasAPagar = () => {
                if (!contasTbody || !noContasMessage) return;
                contasTbody.innerHTML = '';
                noContasMessage.style.display = 'none';
                const sortedContas = [...contasAPagar].sort((a, b) => {
                    const dateAValid = isValidDateString(a.dueDate); const dateBValid = isValidDateString(b.dueDate);
                    const dateA = dateAValid ? new Date(a.dueDate + 'T00:00:00Z') : (a.isPaid ? new Date(0) : new Date(8640000000000000));
                    const dateB = dateBValid ? new Date(b.dueDate + 'T00:00:00Z') : (b.isPaid ? new Date(0) : new Date(8640000000000000));
                    if (a.isPaid !== b.isPaid) return a.isPaid ? 1 : -1;
                    return a.isPaid ? (dateB - dateA) : (dateA - dateB);
                });

                if (sortedContas.length === 0) { noContasMessage.style.display = 'block'; return; }
                const today = new Date();
                const todayUTCStart = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));
                sortedContas.forEach(conta => {
                    if (typeof conta.amount !== 'number' || isNaN(conta.amount)) return;
                    const tr = document.createElement('tr');
                    let statusText = 'Pendente', statusClass = '', dueDateTextClass = '';
                    const isDateValid = isValidDateString(conta.dueDate);
                    const dueDateObj = isDateValid ? new Date(conta.dueDate + 'T00:00:00Z') : null;
                    if (conta.isPaid) { statusText = 'Pago'; statusClass = 'paid';
                    } else if (dueDateObj) {
                        const daysDiff = daysBetween(dueDateObj, todayUTCStart);
                        if (daysDiff < 0) { statusText = `Vencido há ${Math.abs(daysDiff)} dia(s)`; statusClass = 'overdue'; dueDateTextClass = 'overdue-text'; }
                        else if (daysDiff === 0) { statusText = 'Vence Hoje!'; statusClass = 'due-soon'; dueDateTextClass = 'due-soon-text'; }
                        else if (daysDiff <= 3) { statusText = `Vence em ${daysDiff} dia(s)`; statusClass = 'due-soon'; dueDateTextClass = 'due-soon-text'; }
                        else { statusText = `Vence em ${daysDiff} dia(s)`; }
                    } else { statusText = 'Data Inválida'; statusClass = 'overdue'; }
                    tr.className = statusClass;
                    tr.innerHTML = `
                        <td>${escapeHtml(conta.description)}</td><td class="amount">${formatCurrency(conta.amount)}</td>
                        <td class="due-date ${dueDateTextClass}">${formatDate(conta.dueDate)}</td><td>${statusText}</td>
                        <td class="actions">
                            ${!conta.isPaid ? `<button class="mark-paid-btn" data-id="${conta.id}" title="Marcar como Pago">✔️</button>` : ''}
                            <button class="delete-conta-btn" data-id="${conta.id}" title="Excluir Conta">🗑️</button>
                        </td>`;
                    contasTbody.appendChild(tr);
                });
            };

            // Pessoas Devendo: Tabela
            const renderPessoasDevendo = () => {
                if (!pessoasDevendoTbody || !noPessoasDevendoMessage) return;
                pessoasDevendoTbody.innerHTML = '';
                noPessoasDevendoMessage.style.display = 'none';

                const sortedDebtors = [...pessoasDevendo].sort((a, b) => {
                    if (a.isPaid !== b.isPaid) return a.isPaid ? 1 : -1;
                    const dateA = isValidDateString(a.loanDate) ? new Date(a.loanDate + 'T00:00:00Z').getTime() : 0;
                    const dateB = isValidDateString(b.loanDate) ? new Date(b.loanDate + 'T00:00:00Z').getTime() : 0;
                    return dateB - dateA;
                });

                if (sortedDebtors.length === 0) {
                    noPessoasDevendoMessage.style.display = 'block';
                    return;
                }

                sortedDebtors.forEach(debtor => {
                    if (typeof debtor.amount !== 'number' || isNaN(debtor.amount)) return;
                    
                    const totalPaid = (debtor.payments || []).reduce((sum, p) => sum + p.amount, 0);
                    const remainingAmount = debtor.amount - totalPaid;

                    const tr = document.createElement('tr');
                    let statusText = 'Pendente';
                    let rowClass = 'overdue';
                    if (debtor.isPaid) { 
                        statusText = 'Recebido'; 
                        rowClass = 'paid'; 
                    } else if (totalPaid > 0) {
                        statusText = 'Parcialmente Pago';
                    }

                    tr.className = rowClass;
                    tr.innerHTML = `
                        <td>${escapeHtml(debtor.name)}</td>
                        <td class="amount">
                            ${formatCurrency(remainingAmount)}
                            <span class="amount-breakdown">de ${formatCurrency(debtor.amount)}</span>
                        </td>
                        <td>${formatDate(debtor.loanDate)}</td>
                        <td>${statusText}</td>
                        <td class="actions">
                            ${!debtor.isPaid ? `<button class="add-payment-btn" data-id="${debtor.id}" title="Registrar Pagamento Parcial">💰</button>` : ''}
                            ${!debtor.isPaid ? `<button class="mark-received-btn" data-id="${debtor.id}" title="Pagar Valor Restante">✔️</button>` : ''}
                            <button class="download-pdf-btn" data-id="${debtor.id}" title="Baixar PDF da Cobrança">📄</button>
                            <button class="delete-debtor-btn" data-id="${debtor.id}" title="Excluir Registro">🗑️</button>
                        </td>`;
                    pessoasDevendoTbody.appendChild(tr);
                });
            };

            // --- Funções de Renderização de Gráficos ---
            const renderOrUpdateDashboardChart = () => {
                if (!historyChartCanvas || !contentSections.dashboard?.classList.contains('active')) { return; }
                const ctx = historyChartCanvas.getContext('2d'); if (!ctx) return;
                const chartData = prepareDashboardChartData(30);
                if (historyChartInstance) { try { historyChartInstance.destroy(); } catch(e){ console.error(e); } historyChartInstance = null; }
                 try {
                    historyChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: { labels: chartData.labels, datasets: [{ label: 'Saldo Diário', data: chartData.data, borderColor: '#58a6ff', backgroundColor: 'rgba(88, 166, 255, 0.2)', tension: 0.2, fill: true, pointBackgroundColor: '#58a6ff', pointBorderColor: '#1e1e1e', pointHoverRadius: 7, pointHoverBackgroundColor: '#ffffff', pointHoverBorderColor: '#58a6ff', pointRadius: 3 }] },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { grid: { drawBorder: false, color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#a0a0a0', beginAtZero: false, callback: (value) => formatCurrency(value).replace("R$\u00A0","") } }, x: { grid: { display: false }, ticks: { color: '#a0a0a0', maxRotation: 0, autoSkip: true, maxTicksLimit: 6 } } }, plugins: { legend: { display: false }, tooltip: { backgroundColor: '#121212', titleColor: '#ffffff', bodyColor: '#e0e0e0', titleFont: { weight: 'bold' }, bodyFont: { size: 14 }, displayColors: false, borderColor: '#555', borderWidth: 1, padding: 10, callbacks: { title: (tooltipItems) => tooltipItems[0].label, label: (context) => `Saldo: ${formatCurrency(context.parsed.y)}` } } }, interaction: { mode: 'index', intersect: false } }
                    });
                } catch (e) { console.error("Error creating chart:", e); }
            };
            const prepareDashboardChartData = (days = 30) => {
                const balancesPerDay = {}; const labels = []; const data = [];
                const endDate = new Date(); const startDate = new Date();
                startDate.setUTCDate(endDate.getUTCDate() - days + 1);
                const endDateTime = Date.UTC(endDate.getUTCFullYear(), endDate.getUTCMonth(), endDate.getUTCDate(), 23, 59, 59, 999);
                const startDateTime = Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate(), 0, 0, 0, 0);
                let startingBalance = 0;
                transactions.forEach(tx => {
                    if (typeof tx.amount !== 'number' || isNaN(tx.amount) || !isValidDateString(tx.date)) return;
                    const txTime = new Date(tx.date + 'T00:00:00Z').getTime();
                    if (txTime < startDateTime) { startingBalance += (tx.type === 'income' ? tx.amount : -tx.amount); }
                });
                let runningBalance = startingBalance;
                const sortedTxForPeriod = [...transactions].filter(tx => { if (!isValidDateString(tx.date) || typeof tx.amount !== 'number' || isNaN(tx.amount)) return false; const txTime = new Date(tx.date + 'T00:00:00Z').getTime(); return txTime >= startDateTime && txTime <= endDateTime; }).sort((a, b) => { const timeA = new Date(a.date + 'T00:00:00Z').getTime(); const timeB = new Date(b.date + 'T00:00:00Z').getTime(); if (timeA === timeB) return (a.id || 0) - (b.id || 0); return timeA - timeB; });
                sortedTxForPeriod.forEach(tx => { runningBalance += (tx.type === 'income' ? tx.amount : -tx.amount); balancesPerDay[tx.date] = runningBalance; });
                let lastKnownBalance = startingBalance;
                for (let d = new Date(startDate); d.getTime() <= endDate.getTime(); d.setUTCDate(d.getUTCDate() + 1)) {
                    const dayKey = d.toISOString().split('T')[0];
                    const formattedLabel = d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', timeZone: 'UTC' });
                    labels.push(formattedLabel);
                    lastKnownBalance = balancesPerDay[dayKey] ?? lastKnownBalance;
                    data.push(lastKnownBalance);
                }
                if (labels.length === 0) { const todayLabel = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', timeZone: 'UTC' }); labels.push(todayLabel); data.push(startingBalance); }
                return { labels, data };
            };
            const renderReportSectionCharts = () => {
                 if (!contentSections.relatorio?.classList.contains('active')) { return; }
                 if (!topExpensesChartCanvas || !netWorthChartCanvas || !reportCurrentMonthEl || !reportCurrentMonthIncomeEl || !reportCurrentMonthExpenseEl || !noExpensesMessageEl || !noHistoryMessageEl) { return; }
                 const today = new Date(); const currentMonth = today.getUTCMonth(); const currentYear = today.getUTCFullYear();
                 const currentMonthYearStr = today.toISOString().substring(0, 7);
                 reportCurrentMonthEl.textContent = `${monthNamesFullPtBr[currentMonth]} ${currentYear}`;
                 const currentMonthTransactions = transactions.filter(tx => tx.date?.startsWith(currentMonthYearStr));
                 let monthIncome = 0, monthExpense = 0;
                 currentMonthTransactions.forEach(tx => { if (typeof tx.amount !== 'number' || isNaN(tx.amount)) return; if (tx.type === 'income') monthIncome += tx.amount; else if (tx.type === 'expense') monthExpense += tx.amount; });
                 reportCurrentMonthIncomeEl.textContent = formatCurrency(monthIncome);
                 reportCurrentMonthExpenseEl.textContent = formatCurrency(monthExpense);
                 renderTopExpensesChart(currentMonthTransactions);
                 renderNetWorthChart();
            };
            const renderTopExpensesChart = (monthTransactions) => {
                 if (!topExpensesChartCanvas || !noExpensesMessageEl) return;
                 const ctx = topExpensesChartCanvas.getContext('2d'); if (!ctx) return;
                 const expensesByCategory = {};
                 monthTransactions.filter(tx => tx.type === 'expense' && typeof tx.amount === 'number' && tx.amount > 0).forEach(tx => { const category = (tx.description || 'Sem Descrição').trim().toLowerCase(); expensesByCategory[category] = (expensesByCategory[category] || 0) + tx.amount; });
                 const sortedExpenses = Object.entries(expensesByCategory).sort(([, a], [, b]) => b - a);
                 if (topExpensesChartInstance) { try { topExpensesChartInstance.destroy(); } catch(e){ console.error(e); } topExpensesChartInstance = null; }
                 if (sortedExpenses.length === 0) { topExpensesChartCanvas.style.display = 'none'; noExpensesMessageEl.style.display = 'block'; }
                 else {
                     topExpensesChartCanvas.style.display = 'block'; noExpensesMessageEl.style.display = 'none';
                     let topLabels = []; let topData = []; let otherExpensesTotal = 0;
                     sortedExpenses.forEach(([category, amount], index) => { if (index < 3) { topLabels.push(category.charAt(0).toUpperCase() + category.slice(1)); topData.push(amount); } else { otherExpensesTotal += amount; } });
                     if (otherExpensesTotal > 0) { topLabels.push("Outros"); topData.push(otherExpensesTotal); }
                     const backgroundColors = ['rgba(248, 81, 73, 0.7)', 'rgba(243, 156, 18, 0.7)', 'rgba(231, 76, 60, 0.7)', 'rgba(155, 89, 182, 0.7)'];
                     const borderColors = ['rgba(248, 81, 73, 1)', 'rgba(243, 156, 18, 1)', 'rgba(231, 76, 60, 1)', 'rgba(155, 89, 182, 1)'];
                     try {
                         topExpensesChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: topLabels, datasets: [{ label: 'Top Despesas', data: topData, backgroundColor: backgroundColors.slice(0, topData.length), borderColor: borderColors.slice(0, topData.length), borderWidth: 1, hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { color: '#a0a0a0', boxWidth: 12, padding: 15 } }, tooltip: { callbacks: { label: (c) => `${c.label || ''}: ${formatCurrency(c.parsed)}` } } } } });
                     } catch (e) { console.error(e); topExpensesChartCanvas.style.display = 'none'; noExpensesMessageEl.style.display = 'block'; showToast("Erro ao gerar gráfico."); }
                 }
            };
            const renderNetWorthChart = () => {
                 if (!netWorthChartCanvas || !noHistoryMessageEl) return;
                 const ctx = netWorthChartCanvas.getContext('2d'); if (!ctx) return;
                 const { evolutionData } = calculateRunningBalances();
                if (netWorthChartInstance) { try { netWorthChartInstance.destroy(); } catch (e) { console.error(e); } netWorthChartInstance = null; }
                 const monthlyBalances = {};
                 evolutionData.forEach(point => { if (isValidDateString(point.date)) { monthlyBalances[point.date.substring(0, 7)] = point.balance; } });
                 const sortedMonths = Object.keys(monthlyBalances).sort();
                 if (sortedMonths.length < 2) { netWorthChartCanvas.style.display = 'none'; noHistoryMessageEl.style.display = 'block'; }
                 else {
                     netWorthChartCanvas.style.display = 'block'; noHistoryMessageEl.style.display = 'none';
                     const evolutionLabels = sortedMonths.map(monthKey => { const [year, month] = monthKey.split('-'); return `${monthNamesPtBr[parseInt(month) - 1]}/${year.substring(2)}`; });
                     const evolutionChartData = sortedMonths.map(monthKey => monthlyBalances[monthKey]);
                     try {
                         netWorthChartInstance = new Chart(ctx, { type: 'line', data: { labels: evolutionLabels, datasets: [{ label: 'Patrimônio', data: evolutionChartData, borderColor: '#58a6ff', backgroundColor: 'rgba(88, 166, 255, 0.1)', tension: 0.1, fill: true, pointRadius: 3, pointHoverRadius: 6, pointBackgroundColor: '#58a6ff' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false, ticks: { color: '#a0a0a0', callback: (v) => formatCurrency(v) }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, x: { ticks: { color: '#a0a0a0', maxRotation: 45, minRotation: 0 }, grid: { display: false } } }, plugins: { legend: { display: false }, tooltip: { backgroundColor: '#121212', titleColor: '#ffffff', bodyColor: '#e0e0e0', borderColor: '#555', borderWidth: 1, padding: 10, displayColors: false, callbacks: { title: (ti) => ti[0].label, label: (c) => `Patrimônio: ${formatCurrency(c.parsed.y)}` } } }, interaction: { mode: 'index', intersect: false } } });
                     } catch(e) { console.error(e); netWorthChartCanvas.style.display = 'none'; noHistoryMessageEl.style.display = 'block'; showToast("Erro ao gerar gráfico."); }
                 }
            };
            
            // --- Handlers de Eventos ---
            const handleDeleteTransaction = (button) => {
                const transactionId = parseInt(button.dataset.id);
                if (isNaN(transactionId)) return;
                const txIndex = transactions.findIndex(tx => tx.id === transactionId);
                if (txIndex === -1) { showToast("Erro: Movimentação não encontrada."); return; }
                if (confirm(`Tem certeza que deseja excluir "${escapeHtml(transactions[txIndex].description)}"?`)) {
                    transactions.splice(txIndex, 1);
                    saveData(STORAGE_KEYS.transactions, transactions);
                    renderAll();
                    showToast('Movimentação excluída.');
                }
            };
            const handleAddTransaction = (e) => { e.preventDefault(); const dateInput = getElement('tx-date'), descriptionInput = getElement('tx-description'), amountInput = getElement('tx-amount'); const typeInput = transactionForm.querySelector('input[name="tx-type"]:checked'); const amount = parseFloat(amountInput?.value); if (!dateInput?.value || !descriptionInput?.value.trim() || !amountInput?.value || isNaN(amount) || amount <= 0 || !typeInput?.value) { showToast("Erro: Preencha todos os campos corretamente.", 4000); return; } transactions.push({ id: Date.now(), date: dateInput.value, description: descriptionInput.value.trim(), amount: amount, type: typeInput.value }); saveData(STORAGE_KEYS.transactions, transactions); renderAll(); closeModal('add-transaction-modal'); showToast('Movimentação adicionada!'); };
            
            const handleDeletePlanItem = (button) => {
                const itemId = parseInt(button.dataset.id); if (isNaN(itemId)) return;
                const itemIndex = planningItems.findIndex(item => item.id === itemId);
                if (itemIndex > -1) {
                    planningItems.splice(itemIndex, 1);
                    saveData(STORAGE_KEYS.planning, planningItems);
                    renderPlanningTable();
                    showToast('Item removido do plano.');
                }
            };
            const handleAddPlanItem = (e) => { e.preventDefault(); const descriptionInput = getElement('plan-description'), amountInput = getElement('plan-amount'); const typeInput = planItemForm.querySelector('input[name="plan-type"]:checked'); const amount = parseFloat(amountInput?.value); if (!descriptionInput?.value.trim() || !amountInput?.value || isNaN(amount) || amount <= 0 || !typeInput?.value) { showToast("Erro: Preencha todos os campos do plano corretamente.", 4000); return; } planningItems.push({ id: Date.now(), description: descriptionInput.value.trim(), amount: amount, type: typeInput.value }); saveData(STORAGE_KEYS.planning, planningItems); renderPlanningTable(); closeModal('add-plan-item-modal'); showToast('Item adicionado ao plano!'); };
            const handleClearPlan = () => { if (planningItems.length === 0) { showToast('O plano já está vazio.'); return; } if (confirm('Limpar todo o plano?')) { planningItems = []; saveData(STORAGE_KEYS.planning, planningItems); renderPlanningTable(); showToast('Plano limpo.'); } };
            
            const handleAddGoal = (e) => {
                e.preventDefault();
                const descriptionInput = getElement('goal-modal-description');
                const amountInput = getElement('goal-modal-amount');
                const deadlineInput = addGoalForm.querySelector('input[name="goal-deadline"]:checked');
                const targetAmount = parseFloat(amountInput?.value);
                if (!descriptionInput?.value.trim() || !amountInput?.value || isNaN(targetAmount) || targetAmount <= 0 || !deadlineInput?.value) {
                    showToast("Erro: Preencha todos os campos do objetivo.", 4000); return;
                }
                if (targetAmount > 50000) {
                    if (eliteMessageDiv) eliteMessageDiv.style.display = 'block';
                    if (amountInput) amountInput.style.borderColor = '#f39c12';
                    showToast('Objetivos > R$ 50.000 requerem versão Elite.', 4000); return;
                } else {
                    if (eliteMessageDiv) eliteMessageDiv.style.display = 'none';
                    if (amountInput) amountInput.style.borderColor = '';
                }
                const SAVINGS_GRID_VALUES = [5,10,10,5,100,5,20,5,100,20,5,20,50,50,20,50,50,10,100,5,20,10,5,20,5,10,20,10,10,50,20,100,5,10,5,50,20,200,200,100,20,10,10,20,10,5,10,5,10,50,10,5,10,20,10,10,20,50,50,5,50,5,200,10,20,5,50,20,5,20,10,20,10,5,20,10,100,50,10,50,50,20,5,50,100,20,5,20,5,500,10,5,5,10,100,5,20,100,5,10,5,20,100,5,20,50,20,50,50,10,20,200,5,50,10,10,10,5,5,10,10,20,500,20,10,20,500,20,5,50,5,20,20,200,5,5,10,50,200,5,20,100,50,50,10,10,20,5,50,50,100,10,5,5,20,10,100,50,100,5,200,20,5,20,5,20,100,5,50,10,20,5,100,5,10,50,20,10,100,5,5,100,20,200,5,20,5,20,20,100,5,20,5,20,50,10,20,20,5,20,100,5,20,10,5,10,10,5,20,5,20,5,20,5,20,100,5,20,10,100,5,10,100,5,10,5,20];
                function shuffleArray(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a;}
                const shuffledGridValues = shuffleArray([...SAVINGS_GRID_VALUES]).slice(0, 100);

                const startDate = new Date();
                const estimatedCompletionDate = new Date(startDate);
                let monthsToAdd = 0;
                if (deadlineInput.value === 'short') monthsToAdd = 6;
                else if (deadlineInput.value === 'medium') monthsToAdd = 12;
                else if (deadlineInput.value === 'long') monthsToAdd = 36;
                estimatedCompletionDate.setMonth(startDate.getMonth() + monthsToAdd);

                currentGoal = {
                    id: Date.now(),
                    description: descriptionInput.value.trim(),
                    targetAmount: targetAmount,
                    deadlineType: deadlineInput.value,
                    startDate: startDate.toISOString().split('T')[0],
                    estimatedCompletionDate: estimatedCompletionDate.toISOString().split('T')[0],
                    squares: Array(shuffledGridValues.length).fill(false),
                    gridValues: shuffledGridValues
                };
                saveData(STORAGE_KEYS.goal, currentGoal);
                renderGoalSection();
                closeModal('add-goal-modal');
                showToast('Objetivo definido!');
            };
            const handleSquareClick = (square) => { if (!currentGoal || !currentGoal.squares || !Array.isArray(currentGoal.squares)) return; const index = parseInt(square.dataset.index); if (isNaN(index) || index < 0 || index >= currentGoal.squares.length) return; currentGoal.squares[index] = !currentGoal.squares[index]; saveData(STORAGE_KEYS.goal, currentGoal); renderGoalSection(); square.style.transform = 'scale(0.9)'; setTimeout(() => { if (square) square.style.transform = ''; }, 150); };
            const handleRemoveGoal = () => { if (!currentGoal) { showToast("Nenhum objetivo ativo."); return; } if (confirm(`Remover objetivo "${escapeHtml(currentGoal.description)}"?`)) { currentGoal = null; saveData(STORAGE_KEYS.goal, currentGoal); renderGoalSection(); showToast("Objetivo removido."); } };
            
            const handleAddContaSubmit = (e) => { e.preventDefault(); const descriptionInput = getElement('conta-description'), amountInput = getElement('conta-amount'), dueDateInput = getElement('conta-dueDate'); const amount = parseFloat(amountInput?.value); const dueDate = dueDateInput?.value; if (!descriptionInput?.value.trim() || !amountInput?.value || isNaN(amount) || amount <= 0 || !dueDate || !isValidDateString(dueDate)) { showToast('Erro: Preencha todos os campos da conta.', 4000); return; } contasAPagar.push({ id: Date.now(), description: descriptionInput.value.trim(), amount: amount, dueDate: dueDate, isPaid: false }); saveData(STORAGE_KEYS.bills, contasAPagar); renderContasAPagar(); closeModal('add-conta-modal'); showToast('Conta adicionada!'); };
            const handleMarkAsPaidClick = (button) => {
                const contaId = parseInt(button.dataset.id); if (isNaN(contaId)) return;
                const contaIndex = contasAPagar.findIndex(c => c.id === contaId);
                if (contaIndex > -1) {
                    contasAPagar[contaIndex].isPaid = true;
                    saveData(STORAGE_KEYS.bills, contasAPagar);
                    renderContasAPagar();
                    showToast(`Conta "${escapeHtml(contasAPagar[contaIndex].description)}" paga.`);
                } else { showToast("Erro: Conta não encontrada."); }
            };
            const handleDeleteContaClick = (button) => {
                const contaId = parseInt(button.dataset.id); if (isNaN(contaId)) return;
                const contaIndex = contasAPagar.findIndex(c => c.id === contaId);
                if (contaIndex > -1) {
                    if (confirm(`Excluir conta "${escapeHtml(contasAPagar[contaIndex].description)}"?`)) {
                        contasAPagar.splice(contaIndex, 1);
                        saveData(STORAGE_KEYS.bills, contasAPagar);
                        renderContasAPagar();
                        showToast('Conta excluída.');
                    }
                } else { showToast("Erro: Conta não encontrada."); }
            };
            
            // Funções para Múltiplos Itens de Dívida
            const createDebtItemElement = () => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'debt-item';
                itemDiv.innerHTML = `
                    <div class="debt-item-description">
                        <input type="text" class="modal-input debt-item-description-input" placeholder="Descrição do item" required maxlength="100">
                    </div>
                    <div class="debt-item-amount">
                        <input type="number" class="modal-input debt-item-amount-input" placeholder="0.00" required step="0.01" min="0.01">
                    </div>
                    <button type="button" class="remove-debt-item-btn" title="Remover item">&times;</button>
                `;
                return itemDiv;
            };

            const updateDebtorTotal = () => {
                let total = 0;
                debtItemsContainer.querySelectorAll('.debt-item-amount-input').forEach(input => {
                    const value = parseFloat(input.value);
                    if (!isNaN(value) && value > 0) {
                        total += value;
                    }
                });
                debtorTotalAmountDisplay.textContent = `Total: ${formatCurrency(total)}`;
            };

            const handleAddPessoaDevendoSubmit = (e) => {
                e.preventDefault();
                const nameInput = getElement('pessoa-devendo-nome');
                const dateInput = getElement('pessoa-devendo-date');
                if (!nameInput?.value.trim() || !dateInput?.value || !isValidDateString(dateInput.value)) {
                    showToast('Erro: Preencha o nome do devedor e a data.', 4000);
                    return;
                }

                const items = [];
                let isValid = true;
                debtItemsContainer.querySelectorAll('.debt-item').forEach(itemEl => {
                    const description = itemEl.querySelector('.debt-item-description-input').value.trim();
                    const amount = parseFloat(itemEl.querySelector('.debt-item-amount-input').value);
                    if (description && !isNaN(amount) && amount > 0) {
                        items.push({ description, amount });
                    } else {
                        isValid = false;
                    }
                });

                if (!isValid || items.length === 0) {
                    showToast('Erro: Preencha todos os itens da dívida corretamente (descrição e valor).', 4000);
                    return;
                }
                
                const totalAmount = items.reduce((sum, item) => sum + item.amount, 0);

                const newDebtor = {
                    id: Date.now(),
                    name: nameInput.value.trim(),
                    loanDate: dateInput.value,
                    items: items,
                    amount: totalAmount,
                    isPaid: false,
                    payments: [] // <-- NOVO: Array para pagamentos parciais
                };
                
                pessoasDevendo.push(newDebtor);
                saveData(STORAGE_KEYS.debtors, pessoasDevendo);
                renderPessoasDevendo();
                closeModal('add-pessoa-devendo-modal');
                showToast('Devedor adicionado!');
            };

            // NOVO: Abre o modal de pagamento parcial
            const handleAddPaymentClick = (button) => {
                const debtorId = parseInt(button.dataset.id);
                const debtor = pessoasDevendo.find(d => d.id === debtorId);
                if (!debtor) {
                    showToast('Erro: Devedor não encontrado.');
                    return;
                }
                const totalPaid = (debtor.payments || []).reduce((sum, p) => sum + p.amount, 0);
                const remainingAmount = debtor.amount - totalPaid;

                getElement('payment-debtor-id').value = debtorId;
                getElement('payment-modal-debtor-name').textContent = debtor.name;
                getElement('payment-modal-remaining-amount').textContent = `Restante: ${formatCurrency(remainingAmount)}`;
                getElement('payment-amount').value = '';
                getElement('payment-amount').max = remainingAmount.toFixed(2);

                openModal('add-payment-modal');
            };
            
            // NOVO: Processa o formulário de pagamento parcial
            const handlePaymentFormSubmit = (e) => {
                e.preventDefault();
                const debtorId = parseInt(getElement('payment-debtor-id').value);
                const paymentAmountInput = getElement('payment-amount');
                const paymentAmount = parseFloat(paymentAmountInput.value);

                const debtorIndex = pessoasDevendo.findIndex(d => d.id === debtorId);
                if (debtorIndex === -1) {
                    showToast('Erro: Devedor não encontrado.');
                    return;
                }

                const debtor = pessoasDevendo[debtorIndex];
                const totalPaid = (debtor.payments || []).reduce((sum, p) => sum + p.amount, 0);
                const remainingAmount = debtor.amount - totalPaid;

                if (isNaN(paymentAmount) || paymentAmount <= 0) {
                    showToast('Erro: O valor do pagamento deve ser positivo.');
                    return;
                }
                if (paymentAmount > remainingAmount + 0.001) { // Adiciona tolerância para float
                    showToast(`Erro: O pagamento não pode ser maior que o valor restante de ${formatCurrency(remainingAmount)}.`);
                    return;
                }

                if (!debtor.payments) {
                    debtor.payments = [];
                }
                debtor.payments.push({
                    amount: paymentAmount,
                    date: new Date().toISOString().split('T')[0]
                });

                const newTotalPaid = totalPaid + paymentAmount;
                if (newTotalPaid >= debtor.amount - 0.001) {
                    debtor.isPaid = true;
                }

                saveData(STORAGE_KEYS.debtors, pessoasDevendo);
                renderPessoasDevendo();
                closeModal('add-payment-modal');
                showToast(`Pagamento de ${formatCurrency(paymentAmount)} registrado para ${debtor.name}.`);
            };

            const handleMarkAsReceivedClick = (button) => {
                const debtorId = parseInt(button.dataset.id); if (isNaN(debtorId)) return;
                const debtorIndex = pessoasDevendo.findIndex(d => d.id === debtorId);
                if (debtorIndex > -1) {
                    const debtor = pessoasDevendo[debtorIndex];
                    const totalPaid = (debtor.payments || []).reduce((sum, p) => sum + p.amount, 0);
                    const remainingAmount = debtor.amount - totalPaid;

                    if (remainingAmount <= 0) {
                        showToast("Esta dívida já foi totalmente paga.");
                        return;
                    }
                    
                    if (confirm(`Confirmar o recebimento do valor restante de ${formatCurrency(remainingAmount)} para ${debtor.name}?`)) {
                        if (!debtor.payments) debtor.payments = [];
                        debtor.payments.push({ amount: remainingAmount, date: new Date().toISOString().split('T')[0] });
                        debtor.isPaid = true;
                        saveData(STORAGE_KEYS.debtors, pessoasDevendo);
                        renderPessoasDevendo();
                        showToast(`Valor de ${escapeHtml(debtor.name)} recebido integralmente.`);
                    }
                } else { showToast("Erro: Devedor não encontrado."); }
            };
            const handleDeleteDebtorClick = (button) => {
                const debtorId = parseInt(button.dataset.id); if (isNaN(debtorId)) return;
                const debtorIndex = pessoasDevendo.findIndex(d => d.id === debtorId);
                if (debtorIndex > -1) {
                    if (confirm(`Excluir o registro de ${escapeHtml(pessoasDevendo[debtorIndex].name)}?`)) {
                        pessoasDevendo.splice(debtorIndex, 1);
                        saveData(STORAGE_KEYS.debtors, pessoasDevendo);
                        renderPessoasDevendo();
                        showToast('Registro de devedor excluído.');
                    }
                } else { showToast("Erro: Devedor não encontrado."); }
            };
            const handleDownloadPdfClick = (button) => {
                const debtorId = parseInt(button.dataset.id, 10); if (isNaN(debtorId)) return;
                const debtor = pessoasDevendo.find(d => d.id === debtorId);
                if (!debtor) { showToast("Erro: Devedor não encontrado."); return; }
                showToast("Gerando PDF...", 2000);
                
                const totalPaid = (debtor.payments || []).reduce((sum, p) => sum + p.amount, 0);
                const remainingAmount = debtor.amount - totalPaid;

                const invoiceTemplate = getElement('pdf-invoice-template');
                getElement('invoice-status').textContent = debtor.isPaid ? 'Recebido' : 'Em Aberto';
                getElement('invoice-status').className = debtor.isPaid ? 'status-paid' : 'status-unpaid';
                getElement('invoice-number').textContent = `#INV-${debtor.id}`;
                getElement('invoice-date-issued').textContent = formatDate(debtor.loanDate);
                getElement('invoice-bill-to-name').textContent = escapeHtml(debtor.name);
                
                const itemsBody = getElement('invoice-items-body');
                itemsBody.innerHTML = '';
                debtor.items.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td class="item-description">${escapeHtml(item.description)}</td><td class="item-amount">${formatCurrency(item.amount)}</td>`;
                    itemsBody.appendChild(row);
                });
                
                getElement('invoice-subtotal').textContent = formatCurrency(debtor.amount);
                getElement('invoice-paid-amount').textContent = `-${formatCurrency(totalPaid)}`;
                getElement('invoice-total').textContent = formatCurrency(remainingAmount);

                const paymentsTable = getElement('invoice-payments-table');
                paymentsTable.innerHTML = '';
                if(debtor.payments && debtor.payments.length > 0) {
                     getElement('invoice-payments-section').style.display = 'block';
                     debtor.payments.forEach(p => {
                        const row = paymentsTable.insertRow();
                        row.innerHTML = `<td>Pagamento em ${formatDate(p.date)}</td><td style="text-align: right;">${formatCurrency(p.amount)}</td>`;
                     });
                } else {
                    getElement('invoice-payments-section').style.display = 'none';
                }

                html2canvas(invoiceTemplate, { scale: 2 }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    const fileName = `cobranca-${debtor.name.replace(/ /g, '_')}-${debtor.id}.pdf`;
                    pdf.save(fileName);
                    showToast("PDF baixado com sucesso!", 3500);
                }).catch(err => {
                    console.error("Erro ao gerar PDF:", err);
                    showToast("Falha ao gerar o PDF.", 4000);
                });
            };

            // --- Manipulação de Modais ---
            const openModal = (modalId) => {
                const modal = getElement(modalId); if (!modal) return;
                const form = modal.querySelector('form'); if (form) form.reset();
                try {
                    modal.querySelectorAll('input').forEach(i => i.style.borderColor = '');
                    if (modalId === 'add-pessoa-devendo-modal') {
                        getElement('pessoa-devendo-date').value = new Date().toISOString().split('T')[0];
                        debtItemsContainer.innerHTML = '';
                        debtItemsContainer.appendChild(createDebtItemElement());
                        updateDebtorTotal();
                    }
                    if (modalId === 'add-goal-modal') {
                        if (eliteMessageDiv) eliteMessageDiv.style.display = 'none';
                    }
                } catch (resetError) { console.error(`Error in openModal for ${modalId}:`, resetError); }
                modal.style.animation = ''; modal.style.display = 'flex'; void modal.offsetWidth;
                modal.style.animation = 'modalFadeIn 0.4s ease forwards, modalSlideIn 0.5s cubic-bezier(0.25,0.8,0.25,1) forwards';
            };
            const closeModal = (modalId) => {
                const modal = getElement(modalId); if (!modal) return;
                modal.style.animation = 'modalFadeOut 0.4s ease forwards, modalSlideOut 0.4s cubic-bezier(0.6,-0.28,0.735,0.045) forwards';
                setTimeout(() => { if (modal) { modal.style.display = 'none'; modal.style.animation = ''; } }, 400);
            };

            // --- Menu Mobile e Navegação ---
            const toggleMenu = () => {
                sidebar.classList.toggle('is-open');
                menuOverlay.classList.toggle('is-active');
            };

            const handleNavClick = (e) => {
                e.preventDefault();
                const link = e.target.closest('a.nav-link');
                if (!link || link.classList.contains('active')) return;
                const sectionKey = link.dataset.section;
                const targetSection = contentSections[sectionKey];
                if (!targetSection) return;
                navLinks.forEach(navLink => navLink.classList.remove('active'));
                link.classList.add('active');
                Object.values(contentSections).forEach(section => { if (section) section.classList.remove('active'); });
                setTimeout(() => {
                    Object.values(contentSections).forEach(section => { if (section) section.style.display = 'none'; });
                    targetSection.style.display = 'block'; targetSection.classList.add('active');
                    if (sectionKey === 'dashboard') renderOrUpdateDashboardChart();
                    else if (sectionKey === 'relatorio') renderReportSectionCharts();
                    
                    if (window.innerWidth <= 800 && sidebar.classList.contains('is-open')) {
                        toggleMenu();
                    }
                }, 50);
            };

            // --- Função Geral de Renderização ---
            const renderAll = () => {
                renderSummary();
                renderMonthlyTables();
                renderPlanningTable();
                renderGoalSection();
                renderContasAPagar();
                renderPessoasDevendo();
                renderOrUpdateDashboardChart();
                renderReportSectionCharts();
            };
            
            const setupDateButtons = () => {
                document.querySelectorAll('.date-buttons').forEach(buttonGroup => {
                    const dateInput = buttonGroup.nextElementSibling;
                    if (!dateInput || dateInput.tagName !== 'INPUT' || dateInput.type !== 'date') return;
                    buttonGroup.querySelectorAll('.date-button').forEach(button => {
                        button.addEventListener('click', () => {
                            buttonGroup.querySelectorAll('.date-button').forEach(btn => btn.classList.remove('active'));
                            button.classList.add('active');
                            const days = parseInt(button.dataset.days);
                            const date = new Date();
                            if (!isNaN(days)) { date.setDate(date.getDate() + days); dateInput.value = date.toISOString().split('T')[0]; }
                        });
                    });
                    dateInput.addEventListener('change', () => {
                        const selectedDateStr = dateInput.value; if (!selectedDateStr) { buttonGroup.querySelectorAll('.date-button').forEach(btn => btn.classList.remove('active')); return; }
                        let matchedButton = false;
                        buttonGroup.querySelectorAll('.date-button').forEach(button => {
                            const days = parseInt(button.dataset.days); if (isNaN(days)) return;
                            const tempDate = new Date(); tempDate.setHours(0,0,0,0); tempDate.setDate(tempDate.getDate() + days);
                            const buttonDateStr = tempDate.toISOString().split('T')[0];
                            if (selectedDateStr === buttonDateStr) { if (!button.classList.contains('active')) { buttonGroup.querySelectorAll('.date-button').forEach(btn => btn.classList.remove('active')); button.classList.add('active'); } matchedButton = true; }
                        });
                        if (!matchedButton) { buttonGroup.querySelectorAll('.date-button').forEach(btn => btn.classList.remove('active')); }
                    });
                });
            };
            
            // --- INICIALIZAÇÃO E LISTENERS DE EVENTOS ---
            const initializeApp = () => {
                console.log("Initializing Responsive Finance App v10.7...");
                loadData();
                renderAll();
                setupDateButtons();

                // Listeners de Abertura de Modal e Ações Globais
                if (menuToggleBtn) menuToggleBtn.addEventListener('click', toggleMenu);
                if (menuOverlay) menuOverlay.addEventListener('click', toggleMenu);
                if (addTransactionBtn) addTransactionBtn.addEventListener('click', () => openModal('add-transaction-modal'));
                if (addPlanItemBtn) addPlanItemBtn.addEventListener('click', () => openModal('add-plan-item-modal'));
                if (clearPlanBtn) clearPlanBtn.addEventListener('click', handleClearPlan);
                if (addGoalBtn) addGoalBtn.addEventListener('click', () => openModal('add-goal-modal'));
                if (removeGoalBtn) removeGoalBtn.addEventListener('click', handleRemoveGoal);
                if (addContaBtn) addContaBtn.addEventListener('click', () => openModal('add-conta-modal'));
                if (addPessoaDevendoBtn) addPessoaDevendoBtn.addEventListener('click', () => openModal('add-pessoa-devendo-modal'));

                // Listeners de Submissão de Formulários
                if (transactionForm) transactionForm.addEventListener('submit', handleAddTransaction);
                if (planItemForm) planItemForm.addEventListener('submit', handleAddPlanItem);
                if (addGoalForm) addGoalForm.addEventListener('submit', handleAddGoal);
                if (addContaForm) addContaForm.addEventListener('submit', handleAddContaSubmit);
                if (addPessoaDevendoForm) addPessoaDevendoForm.addEventListener('submit', handleAddPessoaDevendoSubmit);
                if (paymentForm) paymentForm.addEventListener('submit', handlePaymentFormSubmit); // NOVO

                // Listeners Globais
                document.body.addEventListener('click', (e) => {
                    if (e.target.classList.contains('close-modal-btn')) {
                        const modalId = e.target.dataset.modalId;
                        if (modalId) closeModal(modalId);
                    }
                    if (e.target.classList.contains('modal')) {
                        closeModal(e.target.id);
                    }
                });
                navLinks.forEach(link => link.addEventListener('click', handleNavClick));

                // Delegação de Eventos para Ações nas Tabelas e Modais Dinâmicos
                if (historySectionContainer) historySectionContainer.addEventListener('click', (e) => {
                    const deleteBtn = e.target.closest('.delete-btn');
                    if (deleteBtn) handleDeleteTransaction(deleteBtn);
                });
                if (planningTbody) planningTbody.addEventListener('click', (e) => {
                    const deleteBtn = e.target.closest('.delete-plan-item-btn');
                    if (deleteBtn) handleDeletePlanItem(deleteBtn);
                });
                if (savingsGridEl) savingsGridEl.addEventListener('click', (e) => {
                    const square = e.target.closest('.savings-square');
                    if (square) handleSquareClick(square);
                });
                if (contasTbody) contasTbody.addEventListener('click', (e) => {
                    const paidBtn = e.target.closest('.mark-paid-btn');
                    const deleteBtn = e.target.closest('.delete-conta-btn');
                    if (paidBtn) handleMarkAsPaidClick(paidBtn);
                    if (deleteBtn) handleDeleteContaClick(deleteBtn);
                });
                if (pessoasDevendoTbody) pessoasDevendoTbody.addEventListener('click', (e) => {
                    const receivedBtn = e.target.closest('.mark-received-btn');
                    const pdfBtn = e.target.closest('.download-pdf-btn');
                    const deleteBtn = e.target.closest('.delete-debtor-btn');
                    const paymentBtn = e.target.closest('.add-payment-btn'); // NOVO
                    if (receivedBtn) handleMarkAsReceivedClick(receivedBtn);
                    if (pdfBtn) handleDownloadPdfClick(pdfBtn);
                    if (deleteBtn) handleDeleteDebtorClick(deleteBtn);
                    if (paymentBtn) handleAddPaymentClick(paymentBtn); // NOVO
                });
                if(addDebtItemBtn) addDebtItemBtn.addEventListener('click', () => {
                    debtItemsContainer.appendChild(createDebtItemElement());
                });
                if(debtItemsContainer) debtItemsContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-debt-item-btn')) {
                        e.target.closest('.debt-item').remove();
                        updateDebtorTotal();
                    }
                });
                if(debtItemsContainer) debtItemsContainer.addEventListener('input', (e) => {
                    if (e.target.classList.contains('debt-item-amount-input')) {
                        updateDebtorTotal();
                    }
                });
                console.log("App Initialized Successfully.");
            };

            initializeApp();
        });
    </script>
</body>
</html>
```
