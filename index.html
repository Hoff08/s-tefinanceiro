<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador Financeiro v10.3 - Corrigido</title> <!-- Vers√£o Atualizada -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Reset B√°sico e Configura√ß√µes Globais */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; }
        body { display: flex; height: 100vh; background-color: #121212; color: #e0e0e0; overflow: hidden; }

        /* --- Scrollbars Customizadas (Opcional) --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #2a2a2a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background-color: #555; border-radius: 4px; border: 2px solid #2a2a2a; }
        ::-webkit-scrollbar-thumb:hover { background-color: #777; }

        /* --- Menu Lateral --- */
        .sidebar { width: 240px; background-color: #1e1e1e; color: #a0a0a0; padding: 20px 10px; display: flex; flex-direction: column; height: 100vh; flex-shrink: 0; box-shadow: 4px 0px 15px rgba(0, 0, 0, 0.3); z-index: 10; overflow-y: auto; transition: transform 0.3s ease-in-out; }
        .sidebar h2 { text-align: center; margin-bottom: 35px; font-size: 1.4em; color: #ffffff; padding-bottom: 15px; flex-shrink: 0; }
        .sidebar nav { flex-grow: 1; }
        .sidebar nav ul { list-style: none; padding-left: 0; }
        .sidebar nav ul li { margin-bottom: 8px; }
        .sidebar nav ul li a { display: flex; align-items: center; padding: 12px 20px; color: #a0a0a0; text-decoration: none; border-radius: 6px; transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease; font-size: 0.95em; font-weight: 500; position: relative; }
        .sidebar nav ul li a i { margin-right: 15px; width: 20px; text-align: center; color: #777; transition: color 0.2s ease; font-style: normal; /* Reset italic if using <i> for icons */ }
        .sidebar nav ul li a:hover { background-color: rgba(255, 255, 255, 0.05); color: #ffffff; transform: translateX(3px); }
        .sidebar nav ul li a:hover i { color: #58a6ff; }
        .sidebar nav ul li a.active { background-color: rgba(88, 166, 255, 0.15); color: #ffffff; font-weight: 600; }
        .sidebar nav ul li a.active i { color: #58a6ff; }
        .sidebar nav ul li a.active::before { content: ''; position: absolute; left: 0; top: 5px; bottom: 5px; width: 4px; background-color: #58a6ff; border-radius: 0 4px 4px 0; }

        /* --- Conte√∫do Principal Wrapper --- */
        .main-container { flex: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* --- Barra Superior --- */
        .top-bar { background-color: #1e1e1e; padding: 15px 30px; display: flex; justify-content: flex-end; align-items: center; border-bottom: 1px solid #333; height: 65px; flex-shrink: 0; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); z-index: 5; }
        .login-placeholder { width: 36px; height: 36px; background-color: #444; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #e0e0e0; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .login-placeholder:hover { transform: scale(1.1); box-shadow: 0 0 10px rgba(88, 166, 255, 0.5); }
        
        /* --- Bot√£o do Menu (Hamburguer) - Inicialmente Escondido --- */
        .menu-toggle-btn {
            display: none;
            background: none;
            border: none;
            cursor: pointer;
            padding: 10px;
            z-index: 1010; 
        }
        .menu-toggle-btn span {
            display: block;
            width: 24px;
            height: 3px;
            background-color: #e0e0e0;
            margin: 5px 0;
            border-radius: 2px;
            transition: all 0.3s ease-in-out;
        }

        /* --- √Årea de Conte√∫do Principal --- */
        .content-area { flex: 1; padding: 35px; overflow-y: auto; background-color: #121212; }
        .content-section { display: none; /* Come√ßa escondido */ }
        .content-section.active { display: block; animation: contentFadeInUp 0.5s ease forwards; }
        @keyframes contentFadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Estilos Comuns Se√ß√µes --- */
        .section-title { font-size: 1.5em; color: #e0e0e0; margin-bottom: 25px; padding-bottom: 10px; border-bottom: 1px solid #444; font-weight: 600; }
        .summary-section { display: flex; flex-wrap: wrap; gap: 30px; margin-bottom: 35px; }
        .summary-card, .planning-summary-card, .report-card { background-color: #282828; padding: 25px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4); border: 1px solid #444; flex: 1; min-width: 200px; transition: transform 0.2s ease, box-shadow 0.2s ease; /* Add transition */ }
        .summary-card:hover, .planning-summary-card:hover, .report-card:hover { transform: translateY(-5px); box-shadow: 0 12px 35px rgba(0, 0, 0, 0.5); }
        .card-title { font-size: 1.1em; color: #b0b0b0; margin-bottom: 15px; font-weight: 600; } /* T√≠tulo dentro dos cards */

        /* --- Dashboard Espec√≠fico --- */
        .balance-card .balance-display { font-size: 2.5em; font-weight: 700; color: #ffffff; margin-bottom: 8px; }
        .balance-card .entry-exit-summary { font-size: 0.9em; color: #a0a0a0; margin-bottom: 20px; }
        .add-button { background: linear-gradient(135deg, #58a6ff, #3b82f6); color: #ffffff; border: none; padding: 12px 25px; font-size: 0.95em; font-weight: 600; border-radius: 8px; cursor: pointer; box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3); transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease; display: inline-flex; align-items: center; gap: 8px; }
        .add-button:hover { background: linear-gradient(135deg, #4a9ae1, #2563eb); transform: translateY(-3px) scale(1.03); box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4); }
        .add-button svg { fill: currentColor; }
        .graph-card .graph-container { position: relative; height: 160px; width: 100%; }

        /* --- Hist√≥rico / Tabelas --- */
        .data-table-container { background-color: #282828; padding: 25px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4); border: 1px solid #444; margin-bottom: 30px; }
        .data-table-container:last-child { margin-bottom: 0; }
        .monthly-table-container h2 { font-size: 1.3em; margin-bottom: 20px; color: #e0e0e0; font-weight: 600; border-bottom: 1px solid #555; padding-bottom: 10px; }
        .data-table { width: 100%; border-collapse: collapse; } /* Common class for tables */
        .data-table thead { border-bottom: 2px solid #555; }
        .data-table th { padding: 12px 15px; text-align: left; color: #b0b0b0; font-weight: 600; font-size: 0.85em; text-transform: uppercase; letter-spacing: 0.5px; }
        .data-table tbody tr { border-bottom: 1px solid #383838; transition: background-color 0.2s ease; }
        .data-table tbody tr:last-child { border-bottom: none; }
        .data-table tbody tr:hover:not(.paid) { background-color: rgba(255, 255, 255, 0.04); }
        .data-table td { padding: 15px; text-align: left; font-size: 0.9em; color: #c0c0c0; vertical-align: middle; }
        .data-table td.amount { font-weight: 600; }
        .income .amount-value { color: #3fb950; } .expense .amount-value { color: #f85149; }
        .type span { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 0.8em; font-weight: 600; }
        .type .type-income { background-color: rgba(63, 185, 80, 0.2); color: #5ae470; }
        .type .type-expense { background-color: rgba(248, 81, 73, 0.2); color: #ff807a; }
        td.actions button { background: none; border: none; color: #888; cursor: pointer; font-size: 1.2em; padding: 5px; transition: color 0.2s ease, transform 0.2s ease; margin-left: 5px; }
        td.actions button:hover { color: #f85149; transform: scale(1.2); }
        .no-data-message { padding: 20px; text-align: center; color: #888; font-style: italic; margin-top: 10px; font-size: 0.9em; }

        /* --- Planejamento --- */
        .planning-summary-section { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; background-color: #282828; padding: 20px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.35); border: 1px solid #444; }
        .planning-summary-card { background-color: #333; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px; text-align: center; border: 1px solid #555; }
        .planning-summary-card h3 { font-size: 1.0em; color: #b0b0b0; margin-bottom: 8px; font-weight: 600;}
        .planning-summary-card .value { font-size: 1.6em; font-weight: 700; margin-top: 5px; display: block; }
        .planning-summary-card .value.positive { color: #3fb950; } .planning-summary-card .value.negative { color: #f85149; } .planning-summary-card .value.neutral { color: #e0e0e0; } .planning-summary-card .value.percent { font-size: 1.4em; }
        .planning-table-section h3 { font-size: 1.3em; margin-bottom: 15px; color: #e0e0e0; font-weight: 600; }
        .planning-table-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;}
        .clear-plan-button { background-color: #666; color: #e0e0e0; border: none; padding: 10px 20px; font-size: 0.9em; font-weight: 600; border-radius: 8px; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease; }
        .clear-plan-button:hover { background-color: #e74c3c; color: #fff; transform: translateY(-2px); }
        .planning-table td.plan-income-col, .planning-table td.plan-expense-col { font-weight: normal; color: #a0a0a0; }
        .planning-table td.plan-income-col.has-value { color: #3fb950; font-weight: 500;} .planning-table td.plan-expense-col.has-value { color: #f85149; font-weight: 500;}

        /* --- Poupan√ßa --- */
        #poupanca-content .goal-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 25px; background-color: #282828; padding: 15px 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 1px solid #444; }
        #poupanca-content .goal-progress-info { display: flex; align-items: center; gap: 15px; flex-grow: 1; min-width: 250px; }
        #poupanca-content .progress-bar-container { width: 150px; height: 10px; background-color: #444; border-radius: 5px; overflow: hidden; }
        #poupanca-content #goal-progress-bar { height: 100%; width: 0%; background-color: #58a6ff; border-radius: 5px; transition: width 0.5s ease; }
        #poupanca-content #goal-progress-percent { font-weight: bold; color: #58a6ff; }
        #poupanca-content #goal-time-elapsed { font-size: 0.9em; color: #a0a0a0; white-space: nowrap; }
        #poupanca-content #add-goal-btn { flex-shrink: 0; }
        #poupanca-content .goal-details { background-color: #282828; padding: 20px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 1px solid #444; }
        #poupanca-content .goal-details h3 { font-size: 1.4em; color: #ffffff; margin-bottom: 15px; }
        #poupanca-content .goal-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; font-size: 0.95em; }
        #poupanca-content .goal-info span { color: #a0a0a0; }
        #poupanca-content .goal-info strong { color: #e0e0e0; margin-left: 5px; }
        #poupanca-content .savings-grid-container { background-color: #282828; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 1px solid #444; margin-bottom: 30px;}
        #poupanca-content .savings-grid-container h4 { font-size: 1.1em; color: #b0b0b0; margin-bottom: 15px; font-weight: 600; }
        #poupanca-content .savings-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 8px; max-width: 500px; margin: 0 auto; }
        #poupanca-content .savings-square { background-color: #444; border: 1px solid #555; border-radius: 4px; aspect-ratio: 1 / 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 1em; font-weight: bold; color: #ccc; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease; user-select: none; position: relative; padding: 2px; line-height: 1.1; text-align: center; }
        #poupanca-content .savings-square[data-value-length="3"] { font-size: 0.9em; }
        #poupanca-content .savings-square[data-value-length="4"] { font-size: 0.8em; }
        #poupanca-content .savings-square[data-value-length="5"] { font-size: 0.7em; }
        #poupanca-content .savings-square:hover:not(.saved) { background-color: #555; transform: scale(1.05); }
        #poupanca-content .savings-square.saved { background-color: #3fb950; border-color: #5ae470; color: rgba(255, 255, 255, 0.7); cursor: pointer; }
        #poupanca-content .savings-square.saved:hover { background-color: #48c75a; transform: scale(1.05); }
        #poupanca-content .savings-square.saved::after { content: '‚úî'; font-size: 1.8em; color: #ffffff; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0.9; pointer-events: none; }
        #poupanca-content .goal-actions { text-align: right; margin-top: 20px; }
        #poupanca-content #remove-goal-btn { background-color: #c0392b; color: white; border: none; padding: 10px 20px; font-size: 0.9em; font-weight: 600; border-radius: 8px; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease; }
        #poupanca-content #remove-goal-btn:hover { background-color: #a93226; transform: translateY(-2px); }
        #poupanca-content .no-goal-message, #poupanca-content .elite-message { padding: 30px; text-align: center; background-color: #282828; border-radius: 10px; margin-top: 20px; border: 1px solid #444; }
        #poupanca-content .no-goal-message p { color: #a0a0a0; margin-bottom: 15px; }
        #poupanca-content .elite-message { color: #f39c12; border-color: #f39c12; display: none; }

        /* --- Contas a Pagar --- */
        #contas-pagar-content .contas-table-container { margin-top: 0; } /* Remove margem extra */
        #contas-pagar-content .contas-table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;}
        .contas-table tbody tr.paid { background-color: rgba(63, 185, 80, 0.1); text-decoration: line-through; }
        .contas-table tbody tr.paid td { color: #777; }
        .contas-table tbody tr.paid .amount { color: #5a9e63; text-decoration: line-through; }
        .contas-table tbody tr.overdue { background-color: rgba(248, 81, 73, 0.1); border-left: 3px solid #f85149; }
        .contas-table tbody tr.due-soon { background-color: rgba(243, 156, 18, 0.1); border-left: 3px solid #f39c12; }
        .contas-table td.due-date.overdue-text { color: #ff807a; font-weight: bold; }
        .contas-table td.due-date.due-soon-text { color: #f5b041; font-weight: bold; }
        .mark-paid-btn { color: #3fb950 !important; }
        .mark-paid-btn:hover { color: #5ae470 !important; transform: scale(1.2); }
        .delete-conta-btn:hover { color: #f85149 !important; }

        /* --- Relat√≥rio --- */
        #relatorio-content h3.report-month-title { font-size: 1.3em; color: #e0e0e0; margin-bottom: 20px; font-weight: 600; border-bottom: 1px solid #555; padding-bottom: 10px; }
        .report-section-container { display: flex; flex-direction: column; gap: 30px; }
        .report-summary-section { display: flex; flex-wrap: wrap; gap: 30px; }
        /* .report-card already defined */
        .report-card h4 { font-size: 1.1em; color: #b0b0b0; margin-bottom: 15px; font-weight: 600; text-align: center; }
        .report-chart-container { position: relative; width: 100%; min-height: 280px; flex-grow: 1; display: flex; align-items: center; justify-content: center;}
        .report-in-out-container { display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 15px; flex-grow: 1; text-align: center; padding: 20px 0; /* Add padding */}
        .report-in-out-container div { margin-bottom: 10px; /* Add margin between in/out */ }
        .report-in-out-container .value { font-size: 1.8em; font-weight: 700; display: block; }
        .report-in-out-container .value.income { color: #3fb950; }
        .report-in-out-container .value.expense { color: #f85149; }
        .report-in-out-container span { color: #a0a0a0; font-size: 0.9em; }
        .report-evolution-container { position: relative; width: 100%; height: 300px; }

        /* --- Modal --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.7); align-items: center; justify-content: center; animation-duration: 0.4s; animation-timing-function: ease; }
        @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modalSlideIn { from { transform: translateY(-40px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        @keyframes modalFadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes modalSlideOut { from { transform: translateY(0) scale(1); opacity: 1; } to { transform: translateY(40px) scale(0.95); opacity: 0; } }
        .modal-content { background-color: #333333; color: #e0e0e0; margin: auto; padding: 35px 45px; border-radius: 15px; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6); width: 90%; max-width: 500px; position: relative; border: 1px solid #555; }
        .close-modal-btn { color: #aaa; position: absolute; top: 18px; right: 25px; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s ease, transform 0.2s ease; }
        .close-modal-btn:hover, .close-modal-btn:focus { color: #ffffff; transform: rotate(90deg); }
        .modal h2 { margin-bottom: 30px; text-align: center; color: #ffffff; font-size: 1.6em; font-weight: 600; }
        .modal label { display: block; margin-bottom: 8px; font-weight: 500; color: #b0b0b0; font-size: 0.9em; }
        .modal input[type="date"], .modal input[type="text"], .modal input[type="number"], .modal select { width: 100%; padding: 12px 14px; margin-bottom: 18px; border: 1px solid #555; border-radius: 8px; font-size: 1em; transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease; background-color: #444; color: #e0e0e0; }
        .modal input:focus, .modal select:focus { border-color: #58a6ff; box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2); outline: none; background-color: #505050; }
        .modal input::placeholder { color: #888; opacity: 1; }
        .modal small { display: block; margin-top: -12px; margin-bottom: 18px; color: #888; font-size: 0.85em;}
        .modal .form-group { margin-bottom: 18px; } /* Group labels and inputs */
        .modal .type-selection, .modal .deadline-selection { display: flex; flex-direction: column; gap: 10px; margin-bottom: 25px; }
        .modal .deadline-selection > label:first-child { margin-bottom: 8px; /* Space for deadline title */ }
        .modal .type-selection label, .modal .deadline-selection label:not(:first-child) { display: flex; align-items: center; cursor: pointer; padding: 12px 15px; border: 1px solid #555; border-radius: 8px; transition: background-color 0.3s ease, border-color 0.3s ease, transform 0.2s ease; justify-content: flex-start; font-weight: 500; background-color: #444; }
        .modal .type-selection label:hover, .modal .deadline-selection label:not(:first-child):hover { background-color: #505050; transform: translateY(-2px); }
        .modal .type-selection input[type="radio"], .modal .deadline-selection input[type="radio"] { margin-right: 10px; accent-color: #58a6ff; display: inline-block !important; width: auto; }
        .modal .type-selection input[type="radio"]:checked + span, .modal .deadline-selection input[type="radio"]:checked + span { font-weight: 600; }
        .modal .type-selection label:has(input[value="income"]:checked), .modal .deadline-selection label:has(input:checked) { border-color: #58a6ff; background-color: rgba(88, 166, 255, 0.15); color: #ffffff; }
        .modal .type-selection label:has(input[value="expense"]:checked) { border-color: #f85149; background-color: rgba(248, 81, 73, 0.25); color: #ff807a; }
        #transaction-form button[type="submit"] { background: linear-gradient(135deg, #3fb950, #33a043); } #transaction-form button[type="submit"]:hover { background: linear-gradient(135deg, #33a043, #2a8a36); }
        #plan-item-form button[type="submit"] { background: linear-gradient(135deg, #f39c12, #e67e22); } #plan-item-form button[type="submit"]:hover { background: linear-gradient(135deg, #e67e22, #d35400); }
        #add-goal-form button[type="submit"] { background: linear-gradient(135deg, #3498db, #2980b9); } #add-goal-form button[type="submit"]:hover { background: linear-gradient(135deg, #2980b9, #1f618d); }
        #add-conta-form button[type="submit"] { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        #add-conta-form button[type="submit"]:hover { background: linear-gradient(135deg, #c0392b, #a93226); }
        .modal button[type="submit"] { color: white; padding: 14px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em; font-weight: 600; width: 100%; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease; margin-top: 15px; }
        .modal button[type="submit"]:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4); }

        /* --- Toast Notification --- */
        .toast-notification { position: fixed; bottom: 25px; right: 25px; background-color: #282828; color: #e0e0e0; padding: 14px 22px; border-radius: 8px; border-left: 4px solid #58a6ff; box-shadow: 0 6px 20px rgba(0,0,0,0.4); z-index: 1001; opacity: 0; visibility: hidden; transition: opacity 0.4s ease, visibility 0.4s ease, transform 0.4s ease; transform: translateX(20px); }
        .toast-notification.show { opacity: 1; visibility: visible; transform: translateX(0); }

        /* --- Media Queries para Responsividade --- */
        @media (max-width: 800px) {
            body {
                overflow: auto; /* Permitir rolagem vertical no body */
                display: block; /* Mudar de flex para block */
            }

            /* --- Menu Lateral (Sidebar) em modo mobile --- */
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                transform: translateX(-100%);
                z-index: 1000;
                width: 260px;
                box-shadow: 6px 0 20px rgba(0,0,0,0.5);
            }
            .sidebar.open {
                transform: translateX(0);
            }

            /* --- Overlay para fechar o menu --- */
            body.sidebar-open::after {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                opacity: 1;
                visibility: visible;
                transition: opacity 0.3s ease;
            }

            /* --- Conte√∫do Principal em modo mobile --- */
            .main-container {
                width: 100%;
                height: auto;
                min-height: 100vh;
                overflow: visible;
            }

            /* --- Barra Superior (Top Bar) --- */
            .top-bar {
                justify-content: space-between;
                padding: 10px 20px;
                position: sticky;
                top: 0;
                z-index: 998;
            }
            .menu-toggle-btn {
                display: block;
            }

            /* --- √Årea de Conte√∫do --- */
            .content-area {
                padding: 25px 15px;
                overflow-y: visible;
            }

            .section-title {
                font-size: 1.3em;
            }

            /* --- Cards --- */
            .summary-section {
                flex-direction: column;
                gap: 20px;
            }
            .summary-card, .report-card {
                min-width: 100%;
            }
            .balance-card .balance-display {
                font-size: 2em;
            }
            .graph-card .graph-container {
                height: 200px;
            }

            /* --- Tabelas Responsivas --- */
            .data-table-container, .contas-table-container {
                overflow-x: auto;
            }
            .data-table {
                min-width: 650px; /* For√ßar largura m√≠nima para criar rolagem */
                white-space: nowrap;
            }
            .data-table td, .data-table th {
                white-space: nowrap;
            }

            /* --- Planejamento --- */
            .planning-summary-section {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            .planning-summary-card {
                min-width: unset;
            }
            .planning-table-actions {
                flex-direction: column;
                align-items: flex-start;
            }
            
            /* --- Poupan√ßa --- */
            #poupanca-content .goal-header {
                flex-direction: column;
                align-items: flex-start;
            }
            #poupanca-content .savings-grid-container {
                padding: 15px;
            }
            #poupanca-content .savings-grid {
                grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
                max-width: 100%;
            }
            #poupanca-content .goal-info {
                grid-template-columns: 1fr;
            }

            /* --- Relat√≥rio --- */
            .report-summary-section {
                flex-direction: column;
            }

            /* --- Modais --- */
            .modal-content {
                padding: 30px 20px;
                width: 95%;
            }
        }

    </style>
</head>
<body>

    <!-- Menu Lateral -->
    <aside class="sidebar">
        <h2>Finance App</h2>
        <nav>
             <ul>
                 <li><a href="#" class="nav-link active" data-section="dashboard"><i>üìä</i> Dashboard</a></li>
                 <li><a href="#" class="nav-link" data-section="futuros-gastos"><i>üîÆ</i> Planejamento</a></li>
                 <li><a href="#" class="nav-link" data-section="poupanca"><i>üê∑</i> Poupan√ßa</a></li>
                 <li><a href="#" class="nav-link" data-section="contas-pagar"><i>üßæ</i> Contas a pagar</a></li>
                 <li><a href="#" class="nav-link" data-section="relatorio"><i>üìà</i> Relat√≥rio</a></li>
                 <li><a href="#" class="nav-link" data-section="objetivos"><i>üéØ</i> Objetivos</a></li>
            </ul>
        </nav>
    </aside>

    <!-- Wrapper Principal -->
    <div class="main-container">
        <!-- Barra Superior -->
        <header class="top-bar">
             <button class="menu-toggle-btn" aria-label="Abrir menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="login-placeholder">U</div> 
        </header>

        <!-- √Årea de Conte√∫do Principal -->
        <main class="content-area">
            <!-- ====================== Se√ß√£o Dashboard ====================== -->
            <div id="dashboard-content" class="content-section active">
                <h2 class="section-title">Dashboard</h2>
                <section class="summary-section">
                    <div class="summary-card balance-card">
                        <h3 class="card-title">Resumo financeiro</h3>
                        <div class="balance-display" id="balance-value">R$ 0,00</div>
                        <div class="entry-exit-summary" id="entry-exit-summary-text">0 entradas / 0 sa√≠das</div>
                        <button id="add-transaction-btn" class="add-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="18" height="18"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg> Adicionar Gasto</button>
                    </div>
                    <div class="summary-card graph-card">
                        <h3 class="card-title">Saldo Di√°rio (√öltimos 30 dias)</h3>
                        <div class="graph-container"><canvas id="historyChart"></canvas></div>
                    </div>
                </section>
                <section id="history-section" class="data-table-container">
                     <h3 class="section-title" style="margin-bottom: 20px; border: none; padding-bottom: 0;">Hist√≥rico de Movimenta√ß√µes</h3>
                     <!-- Placeholder while loading or if empty -->
                     <div class="monthly-table-container" id="history-placeholder" style="display: none;">
                        <p class="no-data-message">Nenhuma movimenta√ß√£o registrada ainda.</p>
                     </div>
                     <!-- Tabelas mensais ser√£o inseridas aqui -->
                </section>
            </div>

            <!-- ====================== Se√ß√£o Planejamento ====================== -->
            <div id="futuros-gastos-content" class="content-section">
                 <h2 class="section-title">Planejamento Futuro</h2>
                <section class="planning-summary-section">
                    <div class="planning-summary-card"><h3>Saldo Planejado</h3><span class="value neutral" id="plan-balance">R$ 0,00</span></div>
                    <div class="planning-summary-card"><h3>% Ganho</h3><span class="value positive percent" id="plan-profit-pct">0,0%</span></div>
                    <div class="planning-summary-card"><h3>% Despesa</h3><span class="value negative percent" id="plan-expense-pct">0,0%</span></div>
                    <div class="planning-summary-card"><h3>Gasto Total</h3><span class="value negative" id="plan-total-expense">R$ 0,00</span></div>
                    <div class="planning-summary-card"><h3>Ganho Total</h3><span class="value positive" id="plan-total-income">R$ 0,00</span></div>
                </section>
                <section class="planning-table-section data-table-container">
                    <div class="planning-table-actions">
                        <h3>Itens do Plano</h3>
                        <button id="add-plan-item-btn" class="add-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="18" height="18"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"></path></svg> Adicionar ao Plano</button>
                    </div>
                    <table class="planning-table data-table">
                        <thead><tr><th>O que</th><th>Valor</th><th>Tipo</th><th>Entrou</th><th>Saiu</th><th>Total Plano</th><th>A√ß√µes</th></tr></thead>
                        <tbody id="planning-tbody">
                            <!-- Placeholder row -->
                            <tr id="no-planning-placeholder" style="display: none;"><td colspan="7" class="no-data-message">Nenhum item no plano.</td></tr>
                        </tbody>
                    </table>
                    <div style="text-align: right; margin-top: 20px;">
                        <button id="clear-plan-btn" class="clear-plan-button">Limpar Plano</button>
                    </div>
                </section>
            </div>

            <!-- ====================== Se√ß√£o Poupan√ßa (Objetivo) ====================== -->
            <div id="poupanca-content" class="content-section">
                <h2 class="section-title">Minha Poupan√ßa / Objetivo</h2>
                <div class="goal-header">
                    <div class="goal-progress-info">
                        <div class="progress-bar-container" title="Progresso"><div id="goal-progress-bar"></div></div>
                        <span id="goal-progress-percent">--%</span>
                        <span id="goal-time-elapsed"></span>
                    </div>
                    <button id="add-goal-btn" class="add-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="18" height="18"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"></path></svg> Definir Objetivo</button>
                </div>
                <div id="no-goal-message" class="no-goal-message" style="display: none;"><p>Voc√™ ainda n√£o definiu um objetivo.</p><p>Clique em "Definir Objetivo"!</p></div>
                <div id="elite-message" class="elite-message" style="display: none;">‚ö†Ô∏è Objetivos > R$ 50.000 requerem vers√£o Elite.</div>
                <div id="goal-active-details" style="display: none;">
                    <div class="goal-details"><h3 id="goal-description">---</h3><div class="goal-info"><div>Meta: <strong id="goal-target-amount">R$ 0,00</strong></div><div>Salvo: <strong id="goal-current-saved">R$ 0,00</strong></div><div>In√≠cio: <strong id="goal-start-date">--/--/----</strong></div><div>Estimativa Fim: <strong id="goal-estimated-completion">--/--/----</strong></div></div></div>
                    <div class="savings-grid-container"><h4>Marque os valores poupados:</h4><div id="savings-grid" class="savings-grid"></div></div>
                    <div class="goal-actions"><button id="remove-goal-btn" title="Remove o objetivo atual">Remover Objetivo</button></div>
                 </div>
            </div>

            <!-- ====================== Se√ß√£o Contas a Pagar ====================== -->
            <div id="contas-pagar-content" class="content-section">
                <h2 class="section-title">Contas a Pagar</h2>
                <button id="add-conta-btn" class="add-button" style="margin-bottom: 25px;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="18" height="18"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"></path></svg>
                    Adicionar Conta/D√≠vida
                </button>
                <div class="contas-table-container data-table-container">
                    <div class="contas-table-header">
                         <h3>Contas Pendentes e Pagas</h3>
                    </div>
                    <table class="contas-table data-table">
                        <thead><tr><th>Descri√ß√£o</th><th>Valor</th><th>Vencimento</th><th>Status</th><th>A√ß√µes</th></tr></thead>
                        <tbody id="contas-tbody">
                            <!-- Linhas das contas ser√£o inseridas aqui -->
                        </tbody>
                    </table>
                    <div id="no-contas-message" class="no-data-message" style="display: none;">
                        Nenhuma conta registrada.
                    </div>
                </div>
            </div>

            <!-- ====================== Se√ß√£o Relat√≥rio ====================== -->
            <div id="relatorio-content" class="content-section">
                <h2 class="section-title">Relat√≥rio Financeiro</h2>
                <h3 id="report-current-month" class="report-month-title">M√™s Atual</h3>
                <div class="report-section-container">
                    <section class="report-summary-section">
                        <div class="report-card">
                            <h4>Top 3 Despesas (M√™s)</h4>
                            <div class="report-chart-container">
                                <canvas id="top-expenses-chart"></canvas>
                                <p id="no-expenses-message" class="no-data-message" style="display: none;">Nenhuma despesa registrada neste m√™s.</p>
                            </div>
                        </div>
                        <div class="report-card">
                             <h4>Entradas vs Sa√≠das (M√™s)</h4>
                            <div class="report-in-out-container">
                                <div>
                                    <span>Entradas</span>
                                    <strong id="report-current-month-income" class="value income">R$ 0,00</strong>
                                </div>
                                <div>
                                    <span>Sa√≠das</span>
                                    <strong id="report-current-month-expense" class="value expense">R$ 0,00</strong>
                                </div>
                            </div>
                        </div>
                    </section>
                    <section class="report-card">
                        <h4>Evolu√ß√£o do Patrim√¥nio (Geral)</h4>
                        <div class="report-evolution-container">
                             <canvas id="net-worth-chart"></canvas>
                             <p id="no-history-message" class="no-data-message" style="display: none;">Dados insuficientes para exibir a evolu√ß√£o.</p>
                        </div>
                    </section>
                 </div>
            </div>

            <!-- ====================== Se√ß√£o Objetivos (Placeholder) ====================== -->
            <div id="objetivos-content" class="content-section">
                <h2 class="section-title">Objetivos</h2>
                <p class="no-data-message">Funcionalidade de objetivos avan√ßados em desenvolvimento.</p>
            </div>
        </main>
    </div>

    <!-- ====================== Modais ====================== -->
    <div id="add-transaction-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" data-modal-id="add-transaction-modal">&times;</span>
            <h2>Adicionar Movimenta√ß√£o</h2>
            <form id="transaction-form" novalidate> <!-- novalidate to handle validation manually -->
                <div class="form-group">
                    <label for="tx-date">Data:</label>
                    <input type="date" id="tx-date" required>
                </div>
                <div class="form-group">
                    <label for="tx-description">Descri√ß√£o:</label>
                    <input type="text" id="tx-description" placeholder="Ex: Sal√°rio" required maxlength="100">
                </div>
                <div class="form-group">
                    <label for="tx-amount">Valor:</label>
                    <input type="number" id="tx-amount" step="0.01" placeholder="0.00" required min="0.01">
                </div>
                <div class="type-selection">
                    <label><input type="radio" name="tx-type" value="income" required><span>üí∞ Entrada</span></label>
                    <label><input type="radio" name="tx-type" value="expense" checked required><span>üí∏ Sa√≠da</span></label>
                </div>
                <button type="submit">Adicionar</button>
            </form>
        </div>
    </div>
    <div id="add-plan-item-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" data-modal-id="add-plan-item-modal">&times;</span>
            <h2>Adicionar ao Plano</h2>
            <form id="plan-item-form" novalidate>
                <div class="form-group">
                    <label for="plan-description">O que:</label>
                    <input type="text" id="plan-description" placeholder="Ex: Investimento" required maxlength="100">
                </div>
                <div class="form-group">
                    <label for="plan-amount">Valor:</label>
                    <input type="number" id="plan-amount" step="0.01" placeholder="0.00" required min="0.01">
                </div>
                <div class="type-selection">
                    <label><input type="radio" name="plan-type" value="income" required><span>‚ûï Entrada</span></label>
                    <label><input type="radio" name="plan-type" value="expense" checked required><span>‚ûñ Sa√≠da</span></label>
                </div>
                <button type="submit">Adicionar</button>
            </form>
        </div>
    </div>
    <div id="add-goal-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" data-modal-id="add-goal-modal">&times;</span>
            <h2>Definir Objetivo</h2>
            <form id="add-goal-form" novalidate>
                <div class="form-group">
                    <label for="goal-modal-description">Motivo:</label>
                    <input type="text" id="goal-modal-description" placeholder="Ex: Viagem" required maxlength="100">
                </div>
                <div class="form-group">
                    <label for="goal-modal-amount">Valor (limite R$ 50k):</label>
                    <input type="number" id="goal-modal-amount" step="0.01" placeholder="1000.00" required min="1" max="50000"> <!-- Corrected max -->
                </div>
                <div class="deadline-selection">
                    <label>Prazo:</label>
                    <label><input type="radio" name="goal-deadline" value="short" required checked><span>6 meses</span></label>
                    <label><input type="radio" name="goal-deadline" value="medium" required><span>1 ano</span></label>
                    <label><input type="radio" name="goal-deadline" value="long" required><span>3 anos</span></label>
                </div>
                <button type="submit">Criar Objetivo</button>
            </form>
        </div>
    </div>
    <div id="add-conta-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" data-modal-id="add-conta-modal">&times;</span>
            <h2>Adicionar Conta ou D√≠vida</h2>
            <form id="add-conta-form" novalidate>
                <div class="form-group">
                    <label for="conta-description">Descri√ß√£o:</label>
                    <input type="text" id="conta-description" placeholder="Ex: Conta de Luz" required maxlength="100">
                </div>
                <div class="form-group">
                    <label for="conta-amount">Valor:</label>
                    <input type="number" id="conta-amount" step="0.01" placeholder="0.00" required min="0.01">
                </div>
                <div class="form-group">
                    <label for="conta-dueDate">Data de Vencimento:</label>
                    <input type="date" id="conta-dueDate" required>
                    <small>(Padr√£o: 1 m√™s a partir de hoje)</small>
                </div>
                <button type="submit">Adicionar Conta</button>
            </form>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast-notification" class="toast-notification">Msg</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Seletores DOM Agrupados ---
            const getElement = (id) => document.getElementById(id); // Helper

            // Gerais & Notifica√ß√£o
            const toastNotification = getElement('toast-notification');
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            const contentSections = {
                'dashboard': getElement('dashboard-content'),
                'futuros-gastos': getElement('futuros-gastos-content'),
                'poupanca': getElement('poupanca-content'),
                'contas-pagar': getElement('contas-pagar-content'),
                'relatorio': getElement('relatorio-content'),
                'objetivos': getElement('objetivos-content'),
            };

            // Dashboard
            const balanceValueEl = getElement('balance-value');
            const entryExitSummaryEl = getElement('entry-exit-summary-text');
            const addTransactionBtn = getElement('add-transaction-btn');
            const historySectionContainer = getElement('history-section');
            const historyPlaceholder = getElement('history-placeholder');
            const historyChartCanvas = getElement('historyChart');

            // Planejamento (Futuros Gastos)
            const planBalanceEl = getElement('plan-balance');
            const planProfitPctEl = getElement('plan-profit-pct');
            const planExpensePctEl = getElement('plan-expense-pct');
            const planTotalExpenseEl = getElement('plan-total-expense');
            const planTotalIncomeEl = getElement('plan-total-income');
            const addPlanItemBtn = getElement('add-plan-item-btn');
            const planningTbody = getElement('planning-tbody');
            const noPlanningPlaceholder = getElement('no-planning-placeholder');
            const clearPlanBtn = getElement('clear-plan-btn');

            // Poupan√ßa (Objetivo)
            const goalProgressBar = getElement('goal-progress-bar');
            const goalProgressPercent = getElement('goal-progress-percent');
            const goalTimeElapsed = getElement('goal-time-elapsed');
            const addGoalBtn = getElement('add-goal-btn');
            const noGoalMessageDiv = getElement('no-goal-message');
            const eliteMessageDiv = getElement('elite-message');
            const goalActiveDetailsDiv = getElement('goal-active-details');
            const goalDescriptionEl = getElement('goal-description');
            const goalTargetAmountEl = getElement('goal-target-amount');
            const goalCurrentSavedEl = getElement('goal-current-saved');
            const goalStartDateEl = getElement('goal-start-date');
            const goalEstimatedCompletionEl = getElement('goal-estimated-completion');
            const savingsGridEl = getElement('savings-grid');
            const removeGoalBtn = getElement('remove-goal-btn');

            // Contas a Pagar
            const addContaBtn = getElement('add-conta-btn');
            const contasTbody = getElement('contas-tbody');
            const noContasMessage = getElement('no-contas-message');

            // Relat√≥rio
            const reportCurrentMonthEl = getElement('report-current-month');
            const topExpensesChartCanvas = getElement('top-expenses-chart');
            const reportCurrentMonthIncomeEl = getElement('report-current-month-income');
            const reportCurrentMonthExpenseEl = getElement('report-current-month-expense');
            const netWorthChartCanvas = getElement('net-worth-chart');
            const noExpensesMessageEl = getElement('no-expenses-message');
            const noHistoryMessageEl = getElement('no-history-message');

            // Modais & Forms
            const transactionModal = getElement('add-transaction-modal');
            const transactionForm = getElement('transaction-form');
            const planItemModal = getElement('add-plan-item-modal');
            const planItemForm = getElement('plan-item-form');
            const addGoalModal = getElement('add-goal-modal');
            const addGoalForm = getElement('add-goal-form');
            const addContaModal = getElement('add-conta-modal');
            const addContaForm = getElement('add-conta-form');

            // --- Constantes ---
            const STORAGE_KEYS = {
                transactions: 'financeTransactions_v10.3',
                planning: 'financePlanningItems_v10.3',
                goal: 'financeCurrentGoal_v10.3',
                bills: 'financeContasAPagar_v10.3'
            };
            const monthNamesPtBr = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
            const monthNamesFullPtBr = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const SAVINGS_GRID_VALUES = [5,10,10,5,100,5,20,5,100,20,5,20,50,50,20,50,50,10,100,5,20,10,5,20,5,10,20,10,10,50,20,100,5,10,5,50,20,200,200,100,20,10,10,20,10,5,10,5,10,50,10,5,10,20,10,10,20,50,50,5,50,5,200,10,20,5,50,20,5,20,10,20,10,5,20,10,100,50,10,50,50,20,5,50,100,20,5,20,5,500,10,5,5,10,100,5,20,100,5,10,5,20,100,5,20,50,20,50,50,10,20,200,5,50,10,10,10,5,5,10,10,20,500,20,10,20,500,20,5,50,5,20,20,200,5,5,10,50,200,5,20,100,50,50,10,10,20,5,50,50,100,10,5,5,20,10,100,50,100,5,200,20,5,20,5,20,100,5,50,10,20,5,100,5,10,50,20,10,100,5,5,100,20,200,5,20,5,20,20,100,5,20,5,20,50,10,20,20,5,20,100,5,20,10,5,10,10,5,20,5,20,5,20,5,20,100,5,20,10,100,5,10,100,5,10,5,20];
            function shuffleArray(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a;}
            const fixedSavingsGridValues = shuffleArray([...SAVINGS_GRID_VALUES]); // Shuffle a copy, ensure it's fixed per session load

            // --- Estado ---
            let transactions = [];
            let planningItems = [];
            let currentGoal = null;
            let contasAPagar = [];
            let historyChartInstance = null;
            let topExpensesChartInstance = null;
            let netWorthChartInstance = null;

            // --- Fun√ß√µes Utilit√°rias ---
            const formatCurrency = (value) => typeof value === 'number' ? value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : 'R$ 0,00';
            const showToast = (message, duration = 3500) => {
                if (!toastNotification) return;
                toastNotification.textContent = message;
                toastNotification.className = 'toast-notification show';
                setTimeout(() => {
                   if (toastNotification) toastNotification.classList.remove('show');
                }, duration);
            };
            const escapeHtml = (unsafe) => unsafe ? unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;") : "";
            // Checks if a string can be parsed into a valid date (basic check)
            const isValidDateString = (dateString) => dateString && !isNaN(Date.parse(dateString + 'T00:00:00Z'));
            // Formats a date string (YYYY-MM-DD) to DD/MM/YYYY using UTC
            const formatDate = (dateString) => {
                if (!isValidDateString(dateString)) return '--/--/----';
                try {
                    // Create date as UTC and format using UTC methods
                    const date = new Date(dateString + 'T00:00:00Z');
                    return date.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
                } catch (e) {
                    console.error("Error formatting date:", dateString, e);
                    return '--/--/----';
                }
            };
            // Calculates difference in days between two Date objects (treats them as UTC dates)
            const daysBetween = (date1, date2) => {
                const oneDay = 86400000; // milliseconds in one day
                // Get UTC timestamps for midnight of each date
                const utc1 = Date.UTC(date1.getUTCFullYear(), date1.getUTCMonth(), date1.getUTCDate());
                const utc2 = Date.UTC(date2.getUTCFullYear(), date2.getUTCMonth(), date2.getUTCDate());
                return Math.round((utc1 - utc2) / oneDay);
            };
            // Gets today's date as YYYY-MM-DD string
            const getTodayDateString = () => new Date().toISOString().split('T')[0];
            // Gets current month as YYYY-MM string
            const getCurrentMonthYearString = () => new Date().toISOString().substring(0, 7);

            // --- Persist√™ncia de Dados ---
            const loadData = () => {
                const loadItem = (key) => {
                    try { return JSON.parse(localStorage.getItem(key)) || []; } catch (e) { console.error(`Error loading ${key}:`, e); return []; }
                };
                const loadGoal = () => {
                     try { return JSON.parse(localStorage.getItem(STORAGE_KEYS.goal)) || null; } catch (e) { console.error('Error loading goal:', e); return null; }
                };
                transactions = loadItem(STORAGE_KEYS.transactions);
                planningItems = loadItem(STORAGE_KEYS.planning);
                contasAPagar = loadItem(STORAGE_KEYS.bills);
                currentGoal = loadGoal();
            };
            const saveData = (key, data) => {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (e) {
                    console.error(`Error saving ${key}:`, e);
                    showToast(`Erro ao salvar dados (${key}). Verifique o espa√ßo de armazenamento.`);
                }
            };

            // --- Fun√ß√µes de C√°lculo Core ---
            // Calculates running balance *after* each transaction and overall balance evolution
            const calculateRunningBalances = () => {
                const balances = {}; // Stores balance keyed by transaction ID
                let currentBalance = 0;
                const evolutionData = []; // Stores { date: 'YYYY-MM-DD', balance: number }

                // Create a copy and sort chronologically, using ID as a stable tie-breaker
                const sortedTransactions = [...transactions].sort((a, b) => {
                    // Handle potential invalid dates gracefully
                    const timeA = isValidDateString(a.date) ? new Date(a.date + 'T00:00:00Z').getTime() : 0;
                    const timeB = isValidDateString(b.date) ? new Date(b.date + 'T00:00:00Z').getTime() : 0;

                    if (timeA === timeB) {
                        return (a.id || 0) - (b.id || 0); // Sort by ID if dates are the same
                    }
                    return timeA - timeB;
                });

                sortedTransactions.forEach(tx => {
                    if (typeof tx.amount !== 'number' || isNaN(tx.amount)) {
                         console.warn("Skipping transaction with invalid amount:", tx);
                         return; // Skip calculation if amount is invalid
                    }
                    const change = (tx.type === 'income' ? tx.amount : -tx.amount);
                    currentBalance += change;
                    if (tx.id) {
                        balances[tx.id] = currentBalance; // Store balance *after* this transaction
                    }
                    if (isValidDateString(tx.date)) {
                        evolutionData.push({ date: tx.date, balance: currentBalance });
                    }
                });
                return { transactionBalances: balances, evolutionData: evolutionData };
            };
            // Groups transactions by month (YYYY-MM)
             const groupTransactionsByMonth = () => {
                 const grouped = {};
                 transactions.forEach(tx => {
                     if (isValidDateString(tx.date)) {
                         const monthKey = tx.date.substring(0, 7); // YYYY-MM
                         if (!grouped[monthKey]) grouped[monthKey] = [];
                         grouped[monthKey].push(tx);
                     } else {
                        console.warn("Transaction with invalid date skipped in grouping:", tx);
                     }
                 });
                 return grouped;
             };

            // --- Fun√ß√µes de Renderiza√ß√£o ---

            // Dashboard: Resumo
            const renderSummary = () => {
                if (!balanceValueEl || !entryExitSummaryEl) return;
                let totalIncome = 0, totalExpense = 0, incomeCount = 0, expenseCount = 0;
                transactions.forEach(tx => {
                    if (typeof tx.amount !== 'number' || isNaN(tx.amount)) return; // Skip invalid amounts
                    if (tx.type === 'income') { totalIncome += tx.amount; incomeCount++; }
                    else if (tx.type === 'expense') { totalExpense += tx.amount; expenseCount++; }
                });
                balanceValueEl.textContent = formatCurrency(totalIncome - totalExpense);
                entryExitSummaryEl.textContent = `${incomeCount} entradas / ${expenseCount} sa√≠das`;
            };

            // Dashboard: Tabela de Hist√≥rico Mensal
            const renderMonthlyTables = () => {
                if (!historySectionContainer || !historyPlaceholder) return;
                // Clear all except the title h3
                while (historySectionContainer.children.length > 1) {
                    historySectionContainer.removeChild(historySectionContainer.lastChild);
                }
                historyPlaceholder.style.display = 'none';

                const groupedTransactions = groupTransactionsByMonth();
                const { transactionBalances } = calculateRunningBalances(); // Get balances after each tx
                const months = Object.keys(groupedTransactions).sort().reverse(); // Newest month first

                if (months.length === 0) {
                    historySectionContainer.appendChild(historyPlaceholder);
                    historyPlaceholder.style.display = 'block';
                    return;
                }

                months.forEach(monthKey => {
                    const [year, month] = monthKey.split('-').map(Number);
                    const monthName = monthNamesFullPtBr[month - 1];
                    const monthTransactions = groupedTransactions[monthKey];

                    const monthContainer = document.createElement('div');
                    monthContainer.className = 'monthly-table-container';
                    monthContainer.id = `month-${monthKey}`;
                    monthContainer.innerHTML = `<h2>${monthName} ${year}</h2>`;

                    const table = document.createElement('table');
                    table.className = 'transactions-table data-table'; // Use common class
                    table.innerHTML = `
                        <thead><tr><th>Data</th><th>Descri√ß√£o</th><th>Valor</th><th>Tipo</th><th>Saldo Ap√≥s</th><th>A√ß√µes</th></tr></thead>
                        <tbody></tbody>`; // Renamed "Total Geral"
                    const tbody = table.querySelector('tbody');

                    // Sort within month: newest first, then by ID for stability on same day
                    monthTransactions.sort((a, b) => {
                        const timeA = isValidDateString(a.date) ? new Date(a.date + 'T00:00:00Z').getTime() : 0;
                        const timeB = isValidDateString(b.date) ? new Date(b.date + 'T00:00:00Z').getTime() : 0;
                        if (timeB === timeA) return (b.id || 0) - (a.id || 0);
                        return timeB - timeA;
                    }).forEach(tx => {
                        const tr = document.createElement('tr');
                        const isExpense = tx.type === 'expense';
                        const amountClass = isExpense ? 'expense' : 'income';
                        const typeText = isExpense ? 'Sa√≠da' : 'Entrada';
                        const typeClass = isExpense ? 'type-expense' : 'type-income';
                        // Get the running balance *after* this transaction occurred
                        const transactionBalance = transactionBalances[tx.id] ?? '---';
                        // Format date as DD/MM using UTC date object
                        const formattedDate = formatDate(tx.date).substring(0, 5); // Get only DD/MM

                        tr.innerHTML = `
                            <td>${formattedDate}</td>
                            <td>${escapeHtml(tx.description)}</td>
                            <td class="amount ${amountClass}"><span class="amount-value">${formatCurrency(tx.amount)}</span></td>
                            <td class="type"><span class="${typeClass}">${typeText}</span></td>
                            <td>${formatCurrency(transactionBalance)}</td>
                            <td class="actions">
                                <button class="delete-btn" data-id="${tx.id}" title="Excluir">üóëÔ∏è</button>
                            </td>`;
                        tbody.appendChild(tr);
                    });

                    monthContainer.appendChild(table);
                    historySectionContainer.appendChild(monthContainer);
                });

                // Add delete listeners AFTER all tables are in the DOM
                historySectionContainer.querySelectorAll('.delete-btn').forEach(button => {
                    button.removeEventListener('click', handleDeleteTransaction); // Prevent duplicates
                    button.addEventListener('click', handleDeleteTransaction);
                });
            };

            // Planejamento: Tabela e Resumo
            const renderPlanningAll = () => {
                renderPlanningTable(); // Summary is updated within renderPlanningTable
            };
            const renderPlanningTable = () => {
                if (!planningTbody || !noPlanningPlaceholder) return;
                planningTbody.innerHTML = ''; // Clear previous rows
                noPlanningPlaceholder.style.display = 'none';

                let runningPlannedTotal = 0;
                let totalPlannedIncome = 0, totalPlannedExpense = 0;

                if (planningItems.length === 0) {
                    noPlanningPlaceholder.style.display = 'table-row';
                } else {
                    planningItems.forEach(item => {
                        if (typeof item.amount !== 'number' || isNaN(item.amount)) return; // Skip invalid
                        const tr = document.createElement('tr');
                        const isExpense = item.type === 'expense';
                        const typeText = isExpense ? 'Sa√≠da' : 'Entrada';
                        const typeClass = isExpense ? 'type-expense' : 'type-income';
                        const incomeValue = !isExpense ? item.amount : 0;
                        const expenseValue = isExpense ? item.amount : 0;
                        runningPlannedTotal += (isExpense ? -item.amount : item.amount);
                        if (isExpense) totalPlannedExpense += item.amount; else totalPlannedIncome += item.amount;

                        tr.innerHTML = `
                            <td>${escapeHtml(item.description)}</td>
                            <td class="amount">${formatCurrency(item.amount)}</td>
                            <td class="type"><span class="${typeClass}">${typeText}</span></td>
                            <td class="plan-income-col ${incomeValue > 0 ? 'has-value' : ''}">${formatCurrency(incomeValue)}</td>
                            <td class="plan-expense-col ${expenseValue > 0 ? 'has-value' : ''}">${formatCurrency(expenseValue)}</td>
                            <td>${formatCurrency(runningPlannedTotal)}</td>
                            <td class="actions">
                                <button class="delete-plan-item-btn" data-id="${item.id}" title="Remover Item do Plano">üóëÔ∏è</button>
                            </td>`;
                        planningTbody.appendChild(tr);
                    });

                    // Add listeners AFTER table is in DOM
                    planningTbody.querySelectorAll('.delete-plan-item-btn').forEach(button => {
                        button.removeEventListener('click', handleDeletePlanItem); // Prevent duplicates
                        button.addEventListener('click', handleDeletePlanItem);
                    });
                }
                 renderPlanningSummary(totalPlannedIncome, totalPlannedExpense); // Update summary card
            };
            const renderPlanningSummary = (totalPlannedIncome, totalPlannedExpense) => {
                if (!planBalanceEl || !planProfitPctEl || !planExpensePctEl || !planTotalExpenseEl || !planTotalIncomeEl) return;
                const plannedBalance = totalPlannedIncome - totalPlannedExpense;
                const totalMagnitude = totalPlannedIncome + totalPlannedExpense;
                let profitPercent = 0, expensePercent = 0;
                if (totalMagnitude > 0) {
                    profitPercent = (totalPlannedIncome / totalMagnitude) * 100;
                    expensePercent = (totalPlannedExpense / totalMagnitude) * 100;
                }
                planBalanceEl.textContent = formatCurrency(plannedBalance);
                planBalanceEl.className = `value ${plannedBalance > 0 ? 'positive' : plannedBalance < 0 ? 'negative' : 'neutral'}`;
                planProfitPctEl.textContent = `${profitPercent.toFixed(1)}%`;
                planExpensePctEl.textContent = `${expensePercent.toFixed(1)}%`;
                planTotalIncomeEl.textContent = formatCurrency(totalPlannedIncome);
                planTotalExpenseEl.textContent = formatCurrency(totalPlannedExpense);
            };

            // Poupan√ßa: Progresso, Detalhes e Grid
            const calculateGoalProgress = () => {
                if (!currentGoal || !currentGoal.squares || !Array.isArray(currentGoal.squares)) {
                    return { savedCount: 0, percent: 0, currentSaved: 0, daysElapsed: 0 };
                }
                let savedCount = 0; let currentSaved = 0;
                // Iterate through the saved state and sum up corresponding values from the fixed grid
                for (let i = 0; i < Math.min(currentGoal.squares.length, fixedSavingsGridValues.length); i++) {
                    if (currentGoal.squares[i]) {
                        savedCount++;
                        currentSaved += fixedSavingsGridValues[i] || 0; // Add value if square is saved
                    }
                }
                let percent = 0;
                if (currentGoal.targetAmount > 0) {
                    percent = (currentSaved / currentGoal.targetAmount) * 100;
                }
                percent = Math.max(0, Math.min(percent, 100)); // Clamp percentage

                let daysElapsed = 0;
                if (currentGoal.startDate && isValidDateString(currentGoal.startDate)) {
                    try {
                        const startDate = new Date(currentGoal.startDate + 'T00:00:00Z');
                        const today = new Date(); // Use local time for "today" to calculate elapsed days naturally
                        const todayUTCStart = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate()));
                        daysElapsed = Math.max(0, daysBetween(todayUTCStart, startDate)); // Ensure non-negative
                    } catch(e) { console.error("Error calculating days elapsed:", e); }
                }

                return { savedCount, percent, currentSaved, daysElapsed };
            };
            const renderGoalSection = () => {
                const hasGoal = !!currentGoal;
                if (noGoalMessageDiv) noGoalMessageDiv.style.display = hasGoal ? 'none' : 'block';
                if (goalActiveDetailsDiv) goalActiveDetailsDiv.style.display = hasGoal ? 'block' : 'none';
                if (addGoalBtn) addGoalBtn.style.display = hasGoal ? 'none' : 'inline-flex';
                if (eliteMessageDiv) eliteMessageDiv.style.display = 'none'; // Hide elite message by default

                if (hasGoal && currentGoal) {
                    const progress = calculateGoalProgress();
                    if (goalProgressBar) goalProgressBar.style.width = `${progress.percent}%`;
                    if (goalProgressPercent) goalProgressPercent.textContent = `${progress.percent.toFixed(0)}%`;
                    if (goalTimeElapsed) goalTimeElapsed.textContent = `Dias: ${progress.daysElapsed}`;
                    if (goalDescriptionEl) goalDescriptionEl.textContent = escapeHtml(currentGoal.description);
                    if (goalTargetAmountEl) goalTargetAmountEl.textContent = formatCurrency(currentGoal.targetAmount);
                    if (goalCurrentSavedEl) goalCurrentSavedEl.textContent = formatCurrency(progress.currentSaved);
                    if (goalStartDateEl) goalStartDateEl.textContent = formatDate(currentGoal.startDate);
                    if (goalEstimatedCompletionEl) goalEstimatedCompletionEl.textContent = formatDate(currentGoal.estimatedCompletionDate);
                    renderSavingsGrid(); // Render grid only if goal exists
                } else {
                    // Reset progress display if no goal
                    if (goalProgressBar) goalProgressBar.style.width = '0%';
                    if (goalProgressPercent) goalProgressPercent.textContent = '--%';
                    if (goalTimeElapsed) goalTimeElapsed.textContent = '';
                    if (savingsGridEl) savingsGridEl.innerHTML = ''; // Clear grid
                }
            };
            const renderSavingsGrid = () => {
                 if (!savingsGridEl || !currentGoal || !currentGoal.squares || !Array.isArray(currentGoal.squares)) return;
                 savingsGridEl.innerHTML = ''; // Clear previous squares
                 const numSquares = Math.min(100, fixedSavingsGridValues.length); // Display max 100 squares

                 // Ensure goal.squares has the correct length
                 if (currentGoal.squares.length !== numSquares) {
                    // Adjust the array length if needed (e.g., if it was saved with a different length previously)
                    const newSquares = Array(numSquares).fill(false);
                    for(let i = 0; i < Math.min(currentGoal.squares.length, numSquares); i++) {
                        newSquares[i] = currentGoal.squares[i];
                    }
                    currentGoal.squares = newSquares;
                 }


                 for (let i = 0; i < numSquares; i++) {
                    const square = document.createElement('div');
                    const value = fixedSavingsGridValues[i] || 0;
                    const valueStr = value.toString();
                    square.className = 'savings-square';
                    square.dataset.index = i;
                    square.dataset.valueLength = valueStr.length; // For potential CSS styling based on length
                    square.textContent = valueStr;
                    square.title = `Marcar ${formatCurrency(value)}`;

                    if (currentGoal.squares[i]) { // Check the state from currentGoal
                        square.classList.add('saved');
                        square.title = `Salvo! (${formatCurrency(value)})`;
                    }

                    square.removeEventListener('click', handleSquareClick); // PREVENT DUPLICATES
                    square.addEventListener('click', handleSquareClick);
                    savingsGridEl.appendChild(square);
                }
            };

            // Contas a Pagar: Tabela
            const renderContasAPagar = () => {
                if (!contasTbody || !noContasMessage) return;
                contasTbody.innerHTML = ''; // Clear previous
                noContasMessage.style.display = 'none';

                const sortedContas = [...contasAPagar].sort((a, b) => {
                    // Handle invalid dates by treating them as very old or very new depending on paid status
                    const dateAValid = isValidDateString(a.dueDate);
                    const dateBValid = isValidDateString(b.dueDate);
                    const dateA = dateAValid ? new Date(a.dueDate + 'T00:00:00Z') : (a.isPaid ? new Date(0) : new Date(8640000000000000)); // Oldest/newest possible
                    const dateB = dateBValid ? new Date(b.dueDate + 'T00:00:00Z') : (b.isPaid ? new Date(0) : new Date(8640000000000000));

                    // Sort logic: Unpaid first, then by due date (oldest first). Paid last, then by due date (newest first).
                    if (a.isPaid !== b.isPaid) return a.isPaid ? 1 : -1; // Unpaid come before paid
                    return a.isPaid ? (dateB - dateA) : (dateA - dateB); // Paid: newest first; Unpaid: oldest first
                });

                if (sortedContas.length === 0) {
                    noContasMessage.style.display = 'block';
                    return;
                }

                const today = new Date();
                // Get midnight UTC of today for accurate comparison with stored UTC dates
                const todayUTCStart = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));

                sortedContas.forEach(conta => {
                    if (typeof conta.amount !== 'number' || isNaN(conta.amount)) return; // Skip invalid
                    const tr = document.createElement('tr');
                    let statusText = 'Pendente';
                    let statusClass = '';
                    let dueDateTextClass = '';
                    const isDateValid = isValidDateString(conta.dueDate);
                    const dueDateObj = isDateValid ? new Date(conta.dueDate + 'T00:00:00Z') : null;

                    if (conta.isPaid) {
                        statusText = 'Pago';
                        statusClass = 'paid';
                    } else if (dueDateObj) { // Only calculate status if date is valid and bill is unpaid
                        const daysDiff = daysBetween(dueDateObj, todayUTCStart); // Compare UTC dates

                        if (daysDiff < 0) { statusText = `Vencido h√° ${Math.abs(daysDiff)} dia(s)`; statusClass = 'overdue'; dueDateTextClass = 'overdue-text'; }
                        else if (daysDiff === 0) { statusText = 'Vence Hoje!'; statusClass = 'due-soon'; dueDateTextClass = 'due-soon-text'; }
                        else if (daysDiff <= 3) { statusText = `Vence em ${daysDiff} dia(s)`; statusClass = 'due-soon'; dueDateTextClass = 'due-soon-text'; }
                        else { statusText = `Vence em ${daysDiff} dia(s)`; }
                    } else {
                        // Handle invalid date for unpaid bills
                        statusText = 'Data Inv√°lida';
                        statusClass = 'overdue'; // Mark as problematic visually
                    }

                    tr.className = statusClass;
                    tr.innerHTML = `
                        <td>${escapeHtml(conta.description)}</td>
                        <td class="amount">${formatCurrency(conta.amount)}</td>
                        <td class="due-date ${dueDateTextClass}">${formatDate(conta.dueDate)}</td>
                        <td>${statusText}</td>
                        <td class="actions">
                            ${!conta.isPaid ? `<button class="mark-paid-btn" data-id="${conta.id}" title="Marcar como Pago">‚úîÔ∏è</button>` : ''}
                            <button class="delete-conta-btn" data-id="${conta.id}" title="Excluir Conta">üóëÔ∏è</button>
                        </td>`;
                    contasTbody.appendChild(tr);
                });

                // Add listeners AFTER table is in DOM
                contasTbody.querySelectorAll('.mark-paid-btn').forEach(btn => { btn.removeEventListener('click', handleMarkAsPaidClick); btn.addEventListener('click', handleMarkAsPaidClick); });
                contasTbody.querySelectorAll('.delete-conta-btn').forEach(btn => { btn.removeEventListener('click', handleDeleteContaClick); btn.addEventListener('click', handleDeleteContaClick); });
            };

            // --- Fun√ß√µes de Renderiza√ß√£o de Gr√°ficos ---

            // Dashboard: Gr√°fico Di√°rio
            const renderOrUpdateDashboardChart = () => {
                // Only render if the dashboard section is active and the canvas exists
                if (!historyChartCanvas || !contentSections.dashboard?.classList.contains('active')) {
                     return;
                }
                const ctx = historyChartCanvas.getContext('2d');
                if (!ctx) { console.error("Failed to get 2D context for historyChartCanvas"); return; }

                const chartData = prepareDashboardChartData(30); // Get data for the last 30 days

                // Destroy previous instance if it exists
                if (historyChartInstance) {
                    try { historyChartInstance.destroy(); } catch(e){ console.error("Error destroying old dashboard chart:", e); }
                    historyChartInstance = null;
                }

                // Create new chart instance
                 try {
                    historyChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: chartData.labels,
                            datasets: [{
                                label: 'Saldo Di√°rio', data: chartData.data,
                                borderColor: '#58a6ff', backgroundColor: 'rgba(88, 166, 255, 0.2)',
                                tension: 0.2, fill: true, pointBackgroundColor: '#58a6ff',
                                pointBorderColor: '#1e1e1e', pointHoverRadius: 7,
                                pointHoverBackgroundColor: '#ffffff', pointHoverBorderColor: '#58a6ff',
                                pointRadius: 3,
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            scales: { y: { grid: { drawBorder: false, color: 'rgba(255, 255, 255, 0.1)', }, ticks: { color: '#a0a0a0', beginAtZero: false, callback: (value) => formatCurrency(value).replace("R$\u00A0","") } }, x: { grid: { display: false, }, ticks: { color: '#a0a0a0', maxRotation: 0, autoSkip: true, maxTicksLimit: 10 } } },
                            plugins: { legend: { display: false }, tooltip: { backgroundColor: '#121212', titleColor: '#ffffff', bodyColor: '#e0e0e0', titleFont: { weight: 'bold' }, bodyFont: { size: 14 }, displayColors: false, borderColor: '#555', borderWidth: 1, padding: 10, callbacks: { title: (tooltipItems) => tooltipItems[0].label, label: (context) => `Saldo: ${formatCurrency(context.parsed.y)}` } } },
                            interaction: { mode: 'index', intersect: false },
                        }
                    });
                } catch (e) {
                    console.error("Error creating dashboard chart:", e);
                     showToast("Erro ao gerar gr√°fico do dashboard.");
                }
            };
            // Prepares data for the dashboard daily balance chart
            const prepareDashboardChartData = (days = 30) => {
                const balancesPerDay = {}; // Stores the *last* balance for each day YYYY-MM-DD
                const labels = []; // DD/MM labels
                const data = [];   // Corresponding balances

                // Define date range using UTC dates for consistency
                const endDate = new Date(); // Today
                const startDate = new Date();
                startDate.setUTCDate(endDate.getUTCDate() - days + 1); // Go back 'days' days

                // Create UTC start/end points for filtering
                const endDateTime = Date.UTC(endDate.getUTCFullYear(), endDate.getUTCMonth(), endDate.getUTCDate(), 23, 59, 59, 999);
                const startDateTime = Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate(), 0, 0, 0, 0);

                // Calculate starting balance (sum of transactions *before* the start date)
                let startingBalance = 0;
                transactions.forEach(tx => {
                    if (typeof tx.amount !== 'number' || isNaN(tx.amount) || !isValidDateString(tx.date)) return;
                    const txTime = new Date(tx.date + 'T00:00:00Z').getTime();
                    if (txTime < startDateTime) {
                        startingBalance += (tx.type === 'income' ? tx.amount : -tx.amount);
                    }
                });

                // Calculate balances for each day within the range
                let runningBalance = startingBalance;
                // Filter and sort transactions within the date range
                const sortedTxForPeriod = [...transactions]
                    .filter(tx => {
                        if (!isValidDateString(tx.date) || typeof tx.amount !== 'number' || isNaN(tx.amount)) return false;
                        const txTime = new Date(tx.date + 'T00:00:00Z').getTime();
                        return txTime >= startDateTime && txTime <= endDateTime;
                    })
                    .sort((a, b) => {
                        const timeA = new Date(a.date + 'T00:00:00Z').getTime();
                        const timeB = new Date(b.date + 'T00:00:00Z').getTime();
                        if (timeA === timeB) return (a.id || 0) - (b.id || 0); // Stable sort by ID
                        return timeA - timeB;
                    });

                // Process transactions within the period to update daily balances
                sortedTxForPeriod.forEach(tx => {
                    runningBalance += (tx.type === 'income' ? tx.amount : -tx.amount);
                    const dayKey = tx.date; // YYYY-MM-DD
                    balancesPerDay[dayKey] = runningBalance; // Overwrite with the latest balance for that day
                });

                // Generate labels and data points for each day in the range
                let lastKnownBalance = startingBalance;
                for (let d = new Date(startDate); d.getTime() <= endDate.getTime(); d.setUTCDate(d.getUTCDate() + 1)) {
                    const dayKey = d.toISOString().split('T')[0]; // YYYY-MM-DD
                    const formattedLabel = d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', timeZone: 'UTC' }); // Use UTC for label consistency
                    labels.push(formattedLabel);
                    // Use the balance recorded for that day, or carry over the last known balance
                    lastKnownBalance = balancesPerDay[dayKey] ?? lastKnownBalance;
                    data.push(lastKnownBalance);
                }

                 // Fallback: If no labels/data generated (e.g., no transactions at all), show starting balance for today
                if (labels.length === 0) {
                     const todayLabel = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', timeZone: 'UTC' });
                     labels.push(todayLabel);
                     data.push(startingBalance); // Show the balance before the (empty) period
                }

                return { labels, data };
            };

            // Relat√≥rio: Renderiza todos os gr√°ficos da se√ß√£o
            const renderReportSectionCharts = () => {
                 // Only render if the report section is active
                 if (!contentSections.relatorio?.classList.contains('active')) {
                     return;
                 }
                 // Ensure all required elements exist
                 if (!topExpensesChartCanvas || !netWorthChartCanvas || !reportCurrentMonthEl || !reportCurrentMonthIncomeEl || !reportCurrentMonthExpenseEl || !noExpensesMessageEl || !noHistoryMessageEl) {
                     console.error("Report section elements missing. Cannot render charts.");
                     return;
                 }

                 const today = new Date();
                 const currentMonth = today.getUTCMonth(); // 0-indexed
                 const currentYear = today.getUTCFullYear();
                 const currentMonthYearStr = today.toISOString().substring(0, 7); // YYYY-MM

                 // Update Month Title
                 reportCurrentMonthEl.textContent = `${monthNamesFullPtBr[currentMonth]} ${currentYear}`;

                 // Filter transactions for the current month
                 const currentMonthTransactions = transactions.filter(tx => tx.date?.startsWith(currentMonthYearStr));

                 // Calculate and display Income vs Expense for the month
                 let monthIncome = 0, monthExpense = 0;
                 currentMonthTransactions.forEach(tx => {
                     if (typeof tx.amount !== 'number' || isNaN(tx.amount)) return;
                     if (tx.type === 'income') monthIncome += tx.amount;
                     else if (tx.type === 'expense') monthExpense += tx.amount;
                 });
                 reportCurrentMonthIncomeEl.textContent = formatCurrency(monthIncome);
                 reportCurrentMonthExpenseEl.textContent = formatCurrency(monthExpense);

                 // Render Top Expenses Doughnut Chart
                 renderTopExpensesChart(currentMonthTransactions);

                 // Render Net Worth Line Chart (using all transactions)
                 renderNetWorthChart();
            };
            // Relat√≥rio: Gr√°fico Top Despesas (Doughnut)
            const renderTopExpensesChart = (monthTransactions) => {
                 if (!topExpensesChartCanvas || !noExpensesMessageEl) return;
                 const ctx = topExpensesChartCanvas.getContext('2d');
                 if (!ctx) { console.error("Failed to get context for topExpensesChartCanvas"); return; }

                 // Aggregate expenses by description (case-insensitive)
                 const expensesByCategory = {};
                 monthTransactions
                    .filter(tx => tx.type === 'expense' && typeof tx.amount === 'number' && tx.amount > 0)
                    .forEach(tx => {
                         const category = (tx.description || 'Sem Descri√ß√£o').trim().toLowerCase();
                         expensesByCategory[category] = (expensesByCategory[category] || 0) + tx.amount;
                 });

                 // Sort categories by amount (descending)
                 const sortedExpenses = Object.entries(expensesByCategory).sort(([, a], [, b]) => b - a);

                 // Destroy previous instance
                 if (topExpensesChartInstance) {
                     try { topExpensesChartInstance.destroy(); } catch(e){ console.error("Error destroying old top expenses chart:", e); }
                     topExpensesChartInstance = null;
                 }

                 if (sortedExpenses.length === 0) {
                     // Show message if no expenses
                     topExpensesChartCanvas.style.display = 'none';
                     noExpensesMessageEl.style.display = 'block';
                 } else {
                     // Prepare data for top 3 + "Outros"
                     topExpensesChartCanvas.style.display = 'block';
                     noExpensesMessageEl.style.display = 'none';
                     let topLabels = []; let topData = []; let otherExpensesTotal = 0;
                     sortedExpenses.forEach(([category, amount], index) => {
                         if (index < 3) {
                             // Capitalize first letter for display
                             topLabels.push(category.charAt(0).toUpperCase() + category.slice(1));
                             topData.push(amount);
                         } else { otherExpensesTotal += amount; }
                     });
                     if (otherExpensesTotal > 0) { topLabels.push("Outros"); topData.push(otherExpensesTotal); }

                     const backgroundColors = ['rgba(248, 81, 73, 0.7)', 'rgba(243, 156, 18, 0.7)', 'rgba(231, 76, 60, 0.7)', 'rgba(155, 89, 182, 0.7)'];
                     const borderColors = ['rgba(248, 81, 73, 1)', 'rgba(243, 156, 18, 1)', 'rgba(231, 76, 60, 1)', 'rgba(155, 89, 182, 1)'];

                     // Create new chart instance
                     try {
                         topExpensesChartInstance = new Chart(ctx, {
                             type: 'doughnut',
                             data: {
                                 labels: topLabels,
                                 datasets: [{
                                     label: 'Top Despesas', data: topData,
                                     backgroundColor: backgroundColors.slice(0, topData.length),
                                     borderColor: borderColors.slice(0, topData.length),
                                     borderWidth: 1, hoverOffset: 4
                                 }]
                             },
                             options: {
                                 responsive: true, maintainAspectRatio: false, cutout: '60%',
                                 plugins: {
                                     legend: { position: 'bottom', labels: { color: '#a0a0a0', boxWidth: 12, padding: 15 } },
                                     tooltip: { callbacks: { label: (c) => `${c.label || ''}: ${formatCurrency(c.parsed)}` } }
                                 }
                             }
                         });
                     } catch (e) {
                         console.error("Error creating top expenses chart:", e);
                         topExpensesChartCanvas.style.display = 'none';
                         noExpensesMessageEl.textContent = "Erro ao gerar gr√°fico."; noExpensesMessageEl.style.display = 'block';
                         showToast("Erro ao gerar gr√°fico de despesas.");
                     }
                 }
            };
            // Relat√≥rio: Gr√°fico Evolu√ß√£o do Patrim√¥nio (Line)
            const renderNetWorthChart = () => {
                 if (!netWorthChartCanvas || !noHistoryMessageEl) return;
                 const ctx = netWorthChartCanvas.getContext('2d');
                 if (!ctx) { console.error("Failed to get context for netWorthChartCanvas"); return; }

                 const { evolutionData } = calculateRunningBalances(); // Get { date: 'YYYY-MM-DD', balance: number } points

                // Destroy previous instance
                if (netWorthChartInstance) {
                    try { netWorthChartInstance.destroy(); } catch (e) { console.error("Error destroying old net worth chart:", e); }
                    netWorthChartInstance = null;
                }

                 // Aggregate balances by month to simplify the chart
                 const monthlyBalances = {};
                 evolutionData.forEach(point => {
                     if (isValidDateString(point.date)) {
                         const monthKey = point.date.substring(0, 7); // YYYY-MM
                         monthlyBalances[monthKey] = point.balance; // Store the *last* balance recorded for that month
                     }
                 });

                 const sortedMonths = Object.keys(monthlyBalances).sort(); // Sort months chronologically

                 if (sortedMonths.length < 2) { // Need at least two data points for a line chart
                     netWorthChartCanvas.style.display = 'none';
                     noHistoryMessageEl.style.display = 'block';
                 } else {
                     netWorthChartCanvas.style.display = 'block';
                     noHistoryMessageEl.style.display = 'none';

                     // Prepare labels (MMM/YY) and data for the chart
                     const evolutionLabels = sortedMonths.map(monthKey => {
                         const [year, month] = monthKey.split('-');
                         return `${monthNamesPtBr[parseInt(month) - 1]}/${year.substring(2)}`; // Format as Jan/23 etc.
                     });
                     const evolutionChartData = sortedMonths.map(monthKey => monthlyBalances[monthKey]);

                     // Create new chart instance
                     try {
                         netWorthChartInstance = new Chart(ctx, {
                             type: 'line',
                             data: {
                                 labels: evolutionLabels,
                                 datasets: [{
                                     label: 'Patrim√¥nio', data: evolutionChartData,
                                     borderColor: '#58a6ff', backgroundColor: 'rgba(88, 166, 255, 0.1)',
                                     tension: 0.1, fill: true, pointRadius: 3, pointHoverRadius: 6, pointBackgroundColor: '#58a6ff'
                                 }]
                             },
                             options: {
                                 responsive: true, maintainAspectRatio: false,
                                 scales: {
                                     y: { beginAtZero: false, ticks: { color: '#a0a0a0', callback: (v) => formatCurrency(v) }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                                     x: { ticks: { color: '#a0a0a0', maxRotation: 45, minRotation: 0 }, grid: { display: false } }
                                 },
                                 plugins: { legend: { display: false }, tooltip: { backgroundColor: '#121212', titleColor: '#ffffff', bodyColor: '#e0e0e0', borderColor: '#555', borderWidth: 1, padding: 10, displayColors: false, callbacks: { title: (ti) => ti[0].label, label: (c) => `Patrim√¥nio: ${formatCurrency(c.parsed.y)}` } } },
                                 interaction: { mode: 'index', intersect: false },
                             }
                         });
                     } catch(e) {
                         console.error("Error creating net worth chart:", e);
                         netWorthChartCanvas.style.display = 'none';
                         noHistoryMessageEl.textContent = "Erro ao gerar gr√°fico."; noHistoryMessageEl.style.display = 'block';
                         showToast("Erro ao gerar gr√°fico de evolu√ß√£o.");
                     }
                 }
            };

            // --- Handlers de Eventos ---

            // Transa√ß√µes: Adicionar
            const handleAddTransaction = (e) => {
                e.preventDefault();
                if (!transactionForm) return;
                const dateInput = getElement('tx-date');
                const descriptionInput = getElement('tx-description');
                const amountInput = getElement('tx-amount');
                const typeInput = transactionForm.querySelector('input[name="tx-type"]:checked');

                // Validation
                const amount = parseFloat(amountInput?.value);
                if (!dateInput?.value || !descriptionInput?.value.trim() || !amountInput?.value || isNaN(amount) || amount <= 0 || !typeInput?.value) {
                    showToast("Erro: Preencha todos os campos corretamente (valor deve ser > 0).", 4000);
                    // Add visual feedback (e.g., red borders) here if desired
                    return;
                }

                const newTransaction = {
                    id: Date.now(), // Simple unique ID using timestamp
                    date: dateInput.value,
                    description: descriptionInput.value.trim(),
                    amount: amount,
                    type: typeInput.value
                };
                transactions.push(newTransaction);
                saveData(STORAGE_KEYS.transactions, transactions);
                renderAll(); // Update UI
                closeModal('add-transaction-modal');
                showToast('Movimenta√ß√£o adicionada!');
            };
            // Transa√ß√µes: Excluir
            const handleDeleteTransaction = (e) => {
                const button = e.target.closest('button'); if (!button) return;
                const transactionId = parseInt(button.dataset.id);
                if (isNaN(transactionId)) { console.error("Invalid transaction ID for deletion"); return; }

                const txIndex = transactions.findIndex(tx => tx.id === transactionId);
                if (txIndex === -1) { showToast("Erro: Movimenta√ß√£o n√£o encontrada para exclus√£o."); return; }

                // Confirmation Dialog
                if (confirm(`Tem certeza que deseja excluir a movimenta√ß√£o "${escapeHtml(transactions[txIndex].description)}"?`)) {
                    transactions.splice(txIndex, 1); // Remove from array
                    saveData(STORAGE_KEYS.transactions, transactions);
                    renderAll(); // Update UI
                    showToast('Movimenta√ß√£o exclu√≠da.');
                }
            };

            // Planejamento: Adicionar Item
            const handleAddPlanItem = (e) => {
                 e.preventDefault();
                 if (!planItemForm) return;
                 const descriptionInput = getElement('plan-description');
                 const amountInput = getElement('plan-amount');
                 const typeInput = planItemForm.querySelector('input[name="plan-type"]:checked');

                 // Validation
                 const amount = parseFloat(amountInput?.value);
                 if (!descriptionInput?.value.trim() || !amountInput?.value || isNaN(amount) || amount <= 0 || !typeInput?.value) {
                    showToast("Erro: Preencha todos os campos do plano corretamente (valor > 0).", 4000); return;
                 }

                const newPlanItem = { id: Date.now(), description: descriptionInput.value.trim(), amount: amount, type: typeInput.value };
                planningItems.push(newPlanItem);
                saveData(STORAGE_KEYS.planning, planningItems);
                renderPlanningAll(); // Update Planning UI
                closeModal('add-plan-item-modal');
                showToast('Item adicionado ao plano!');
            };
            // Planejamento: Excluir Item
            const handleDeletePlanItem = (e) => {
                 const button = e.target.closest('button'); if (!button) return;
                 const itemId = parseInt(button.dataset.id); if (isNaN(itemId)) { console.error("Invalid plan item ID"); return; }

                 const itemIndex = planningItems.findIndex(item => item.id === itemId);
                 if (itemIndex === -1) { showToast("Erro: Item do plano n√£o encontrado."); return; }

                 // No confirmation needed for plan items? Add if desired.
                 planningItems.splice(itemIndex, 1);
                 saveData(STORAGE_KEYS.planning, planningItems);
                 renderPlanningAll(); // Update Planning UI
                 showToast('Item removido do plano.');
            };
            // Planejamento: Limpar Plano
            const handleClearPlan = () => {
                if (planningItems.length === 0) { showToast('O plano j√° est√° vazio.'); return; }
                if (confirm('Tem certeza que deseja limpar todo o plano? Esta a√ß√£o n√£o pode ser desfeita.')) {
                    planningItems = [];
                    saveData(STORAGE_KEYS.planning, planningItems);
                    renderPlanningAll(); // Update Planning UI
                    showToast('Plano limpo.');
                }
            };

            // Poupan√ßa/Objetivo: Adicionar/Definir
            const handleAddGoal = (e) => {
                e.preventDefault();
                if (!addGoalForm) return;
                const descriptionInput = getElement('goal-modal-description');
                const amountInput = getElement('goal-modal-amount');
                const deadlineInput = addGoalForm.querySelector('input[name="goal-deadline"]:checked');

                // Validation
                const targetAmount = parseFloat(amountInput?.value);
                if (!descriptionInput?.value.trim() || !amountInput?.value || isNaN(targetAmount) || targetAmount <= 0 || !deadlineInput?.value) {
                     showToast("Erro: Preencha todos os campos do objetivo corretamente (valor > 0).", 4000); return;
                }

                // Elite Check (Optional - Keep or remove as needed)
                if (targetAmount > 50000) {
                    if (eliteMessageDiv) eliteMessageDiv.style.display = 'block';
                    if (amountInput) amountInput.style.borderColor = '#f39c12'; // Visual feedback
                    showToast('Objetivos acima de R$ 50.000 requerem a vers√£o Elite.', 4000); return;
                } else {
                     if (eliteMessageDiv) eliteMessageDiv.style.display = 'none';
                     if (amountInput) amountInput.style.borderColor = ''; // Reset border
                }

                // Calculate start and estimated end dates
                const startDate = new Date(); // Use local time for start date
                const estimatedCompletionDate = new Date(startDate);
                let monthsToAdd = 0;
                if (deadlineInput.value === 'short') monthsToAdd = 6;
                else if (deadlineInput.value === 'medium') monthsToAdd = 12;
                else if (deadlineInput.value === 'long') monthsToAdd = 36;
                estimatedCompletionDate.setMonth(startDate.getMonth() + monthsToAdd);

                // Create new goal object
                currentGoal = {
                    id: Date.now(),
                    description: descriptionInput.value.trim(),
                    targetAmount: targetAmount,
                    deadlineType: deadlineInput.value,
                    startDate: startDate.toISOString().split('T')[0], // Store as YYYY-MM-DD
                    estimatedCompletionDate: estimatedCompletionDate.toISOString().split('T')[0], // Store as YYYY-MM-DD
                    squares: Array(100).fill(false) // Initialize 100 squares (can adjust if grid size changes)
                };
                saveData(STORAGE_KEYS.goal, currentGoal);
                renderGoalSection(); // Update Goal UI
                closeModal('add-goal-modal');
                showToast('Objetivo definido com sucesso!');
            };
            // Poupan√ßa/Objetivo: Clicar no Quadrado
            const handleSquareClick = (e) => {
                if (!currentGoal || !currentGoal.squares || !Array.isArray(currentGoal.squares)) return;
                const square = e.target.closest('.savings-square'); if (!square) return;
                const index = parseInt(square.dataset.index);
                if (isNaN(index) || index < 0 || index >= currentGoal.squares.length) {
                    console.error("Invalid square index clicked:", index); return;
                }

                // Toggle the saved state for this square
                currentGoal.squares[index] = !currentGoal.squares[index];
                saveData(STORAGE_KEYS.goal, currentGoal);
                renderGoalSection(); // Re-render progress and grid to reflect change

                // Optional: Quick visual feedback on click
                square.style.transform = 'scale(0.9)';
                setTimeout(() => { if (square) square.style.transform = ''; }, 150);
            };
            // Poupan√ßa/Objetivo: Remover
            const handleRemoveGoal = () => {
                if (!currentGoal) { showToast("Nenhum objetivo ativo para remover."); return; }
                if (confirm(`Tem certeza que deseja remover o objetivo "${escapeHtml(currentGoal.description)}"? Todo o progresso ser√° perdido.`)) {
                    currentGoal = null;
                    saveData(STORAGE_KEYS.goal, currentGoal);
                    renderGoalSection(); // Update Goal UI (will show 'no goal' message)
                    showToast("Objetivo removido.");
                }
            };

            // Contas a Pagar: Adicionar
             const handleAddContaSubmit = (e) => {
                e.preventDefault();
                if (!addContaForm) return;
                const descriptionInput = getElement('conta-description');
                const amountInput = getElement('conta-amount');
                const dueDateInput = getElement('conta-dueDate');

                 // Validation
                 const amount = parseFloat(amountInput?.value);
                 const dueDate = dueDateInput?.value;
                 if (!descriptionInput?.value.trim() || !amountInput?.value || isNaN(amount) || amount <= 0 || !dueDate || !isValidDateString(dueDate)) {
                    showToast('Erro: Preencha todos os campos da conta corretamente (data v√°lida e valor > 0).', 4000); return;
                 }

                const newConta = {
                    id: Date.now(),
                    description: descriptionInput.value.trim(),
                    amount: amount,
                    dueDate: dueDate, // Store as YYYY-MM-DD
                    isPaid: false
                };
                contasAPagar.push(newConta);
                saveData(STORAGE_KEYS.bills, contasAPagar);
                renderContasAPagar(); // Update Bills UI
                closeModal('add-conta-modal');
                showToast('Conta adicionada com sucesso!');
            };
            // Contas a Pagar: Marcar como Paga
             const handleMarkAsPaidClick = (e) => {
                const button = e.target.closest('button'); if (!button) return;
                const contaId = parseInt(button.dataset.id); if (isNaN(contaId)) { console.error("Invalid bill ID"); return; }

                const contaIndex = contasAPagar.findIndex(c => c.id === contaId);
                if (contaIndex > -1) {
                    contasAPagar[contaIndex].isPaid = true;
                    saveData(STORAGE_KEYS.bills, contasAPagar);
                    renderContasAPagar(); // Update Bills UI
                    showToast(`Conta "${escapeHtml(contasAPagar[contaIndex].description)}" marcada como paga.`);
                } else { showToast("Erro: Conta n√£o encontrada para marcar como paga."); }
             };
            // Contas a Pagar: Excluir
             const handleDeleteContaClick = (e) => {
                const button = e.target.closest('button'); if (!button) return;
                const contaId = parseInt(button.dataset.id); if (isNaN(contaId)) { console.error("Invalid bill ID"); return; }

                const contaIndex = contasAPagar.findIndex(c => c.id === contaId);
                 if (contaIndex > -1) {
                     // Confirmation
                     if (confirm(`Tem certeza que deseja excluir a conta "${escapeHtml(contasAPagar[contaIndex].description)}"?`)) {
                        contasAPagar.splice(contaIndex, 1);
                        saveData(STORAGE_KEYS.bills, contasAPagar);
                        renderContasAPagar(); // Update Bills UI
                        showToast('Conta exclu√≠da.');
                    }
                 } else { showToast("Erro: Conta n√£o encontrada para excluir."); }
             };

            // --- Manipula√ß√£o de Modais ---
            const openModal = (modalId) => {
                const modal = getElement(modalId); if (!modal) return;
                const form = modal.querySelector('form');
                if (form) form.reset(); // Reset form fields

                // Reset specific styles and set defaults per modal
                 try {
                    // Clear any previous validation styles
                    modal.querySelectorAll('input').forEach(i => i.style.borderColor = '');

                    if (modalId === 'add-transaction-modal') {
                        const dateInput = getElement('tx-date'); if (dateInput) dateInput.value = getTodayDateString();
                        const expenseRadio = modal.querySelector('input[name="tx-type"][value="expense"]'); if(expenseRadio) expenseRadio.checked = true;
                    } else if (modalId === 'add-plan-item-modal') {
                        const expenseRadio = modal.querySelector('input[name="plan-type"][value="expense"]'); if(expenseRadio) expenseRadio.checked = true;
                    } else if (modalId === 'add-goal-modal') {
                        const shortRadio = modal.querySelector('input[name="goal-deadline"][value="short"]'); if(shortRadio) shortRadio.checked = true;
                        if (eliteMessageDiv) eliteMessageDiv.style.display = 'none'; // Hide elite message on open
                    } else if (modalId === 'add-conta-modal') {
                         const dueDateInput = getElement('conta-dueDate');
                         if (dueDateInput) {
                            // Default due date to 1 month from today
                            try {
                                const today = new Date();
                                today.setMonth(today.getMonth() + 1);
                                dueDateInput.value = today.toISOString().split('T')[0];
                             } catch(e){ // Fallback to today if date calculation fails
                                console.error("Error setting default due date:", e);
                                dueDateInput.value = getTodayDateString();
                             }
                         }
                    }
                } catch (resetError) { console.error(`Error resetting modal ${modalId}:`, resetError); }

                // Display modal with animation
                modal.style.animation = ''; // Clear previous animation
                modal.style.display = 'flex';
                void modal.offsetWidth; // Trigger reflow to restart animation
                modal.style.animation = 'modalFadeIn 0.4s ease forwards, modalSlideIn 0.5s cubic-bezier(0.25,0.8,0.25,1) forwards';
            };
            const closeModal = (modalId) => {
                const modal = getElement(modalId); if (!modal) return;
                // Animate out
                modal.style.animation = 'modalFadeOut 0.4s ease forwards, modalSlideOut 0.4s cubic-bezier(0.6,-0.28,0.735,0.045) forwards';
                // Hide after animation
                setTimeout(() => {
                    if (modal) {
                         modal.style.display = 'none';
                         modal.style.animation = ''; // Clear animation state
                    }
                }, 400); // Match animation duration
            };

            // --- Navega√ß√£o ---
            const handleNavClick = (e) => {
                e.preventDefault();
                const link = e.target.closest('a.nav-link');
                if (!link || link.classList.contains('active')) return; // Ignore clicks on active link or outside links

                const sectionKey = link.dataset.section;
                const targetSection = contentSections[sectionKey];
                if (!targetSection) { console.warn(`Content section for '${sectionKey}' not found.`); return; }

                // Update navigation links appearance
                navLinks.forEach(navLink => navLink.classList.remove('active'));
                link.classList.add('active');

                // Switch content sections
                Object.values(contentSections).forEach(section => { if (section) section.classList.remove('active'); }); // Remove active first

                // Use timeout to ensure fade-out/in animation triggers correctly if styles rely on .active
                setTimeout(() => {
                    Object.values(contentSections).forEach(section => { if (section) section.style.display = 'none'; }); // Hide all first
                    targetSection.style.display = 'block'; // Display target
                    targetSection.classList.add('active'); // Add active class for animation

                    // Trigger chart rendering ONLY for the newly active section if it has charts
                    if (sectionKey === 'dashboard') renderOrUpdateDashboardChart();
                    else if (sectionKey === 'relatorio') renderReportSectionCharts();
                }, 50); // Small delay for smooth transition
            };

            // --- Fun√ß√£o Geral de Renderiza√ß√£o ---
            const renderAll = () => {
                // Render non-chart UI elements immediately
                renderSummary();
                renderMonthlyTables();
                renderPlanningAll();
                renderGoalSection();
                renderContasAPagar();

                // Trigger chart renders (they will check internally if their section is active)
                renderOrUpdateDashboardChart();
                renderReportSectionCharts();
            };

            // --- Inicializa√ß√£o ---
            const initializeApp = () => {
                console.log("Initializing Finance App v10.3 (Corrected)...");
                loadData(); // Load data from localStorage

                // Setup Initial State (Dashboard Active)
                Object.values(contentSections).forEach(section => {
                     if (section) { section.style.display = 'none'; section.classList.remove('active'); }
                });
                if (contentSections.dashboard) {
                    contentSections.dashboard.style.display = 'block';
                    contentSections.dashboard.classList.add('active');
                } else { console.error("CRITICAL: Dashboard content section not found!"); }

                navLinks.forEach(l => l.classList.remove('active'));
                const dashboardLink = document.querySelector('.nav-link[data-section="dashboard"]');
                if (dashboardLink) dashboardLink.classList.add('active'); else console.error("CRITICAL: Dashboard nav link not found!");

                // Initial Render of all components
                renderAll();

                // Attach Event Listeners
                if (addTransactionBtn) addTransactionBtn.addEventListener('click', () => openModal('add-transaction-modal'));
                if (transactionForm) transactionForm.addEventListener('submit', handleAddTransaction);
                if (addPlanItemBtn) addPlanItemBtn.addEventListener('click', () => openModal('add-plan-item-modal'));
                if (planItemForm) planItemForm.addEventListener('submit', handleAddPlanItem);
                if (clearPlanBtn) clearPlanBtn.addEventListener('click', handleClearPlan);
                if (addGoalBtn) addGoalBtn.addEventListener('click', () => openModal('add-goal-modal'));
                if (addGoalForm) addGoalForm.addEventListener('submit', handleAddGoal);
                if (removeGoalBtn) removeGoalBtn.addEventListener('click', handleRemoveGoal);
                if (addContaBtn) addContaBtn.addEventListener('click', () => openModal('add-conta-modal'));
                if (addContaForm) addContaForm.addEventListener('submit', handleAddContaSubmit);

                // Modal Close Button Listeners
                document.querySelectorAll('.close-modal-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const modalId = e.target.dataset.modalId;
                        if (modalId) closeModal(modalId);
                    });
                });
                // Modal Background Click Listener
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal.id); }); // Close if click is on backdrop
                });

                // Navigation Listener
                navLinks.forEach(link => link.addEventListener('click', handleNavClick));

                // --- Mobile Sidebar Logic ---
                const menuToggleBtn = document.querySelector('.menu-toggle-btn');
                const sidebar = document.querySelector('.sidebar');
                const body = document.body;

                const closeSidebar = () => {
                    if (sidebar) sidebar.classList.remove('open');
                    if (body) body.classList.remove('sidebar-open');
                };

                if (menuToggleBtn && sidebar) {
                    menuToggleBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        sidebar.classList.toggle('open');
                        body.classList.toggle('sidebar-open');
                    });
                }

                // Close sidebar when a nav link is clicked (for SPA navigation)
                sidebar.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', () => {
                        if (sidebar.classList.contains('open')) {
                            closeSidebar();
                        }
                    });
                });

                // Close sidebar when clicking on the overlay (the body itself when open)
                body.addEventListener('click', (e) => {
                    if (sidebar.classList.contains('open') && !sidebar.contains(e.target) && e.target !== menuToggleBtn) {
                        closeSidebar();
                    }
                });


                console.log("App Initialized Successfully.");
            };

            // --- Iniciar a Aplica√ß√£o ---
            initializeApp();

        }); // End DOMContentLoaded
    </script>

</body>
</html>